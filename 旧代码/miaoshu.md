# ä¸€ã€LingChat 0.4 è¦åšä»€ä¹ˆï¼Ÿ

åœ¨LingChat 0.1ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªä½¿ç”¨ä»¿ç¢§è“æ¡£æ¡ˆUIçš„ï¼Œæœ‰è¯­éŸ³å’Œç«‹ç»˜åˆ‡æ¢çš„ï¼Œå’ŒAIèŠå¤©çš„ç³»ç»Ÿã€‚

åœ¨LingChat 0.2ï¼Œæˆ‘ä»¬ç»™ç³»ç»Ÿæ·»åŠ äº†RAGå®ç°è·¨è¶Šå¯¹è¯çš„æ°¸ä¹…è®°å¿†ï¼Œæ—¶é—´æ„ŸçŸ¥ï¼Œä»¥åŠå­˜æ¡£è¯»æ¡£åŠŸèƒ½

åœ¨LingChat 0.3ï¼Œæˆ‘ä»¬å®Œå–„äº†å„ä¸ªåŠŸèƒ½ï¼Œæ·»åŠ äº†å¤šäººç‰©æ”¯æŒï¼Œåˆ›æ„å·¥åŠï¼ŒéŸ³ä¹å’ŒèƒŒæ™¯å¯¼å…¥ï¼Œä½¿å¾—LingChat å¯ä»¥è¢«æ·±åº¦è‡ªå®šä¹‰ï¼Œå¹¶å¢åŠ äº†æ˜“ç”¨æ€§ã€‚

è‡³æ­¤ï¼Œä¸€ä¸ªâ€œä½¿ç”¨ä»¿ç¢§è“æ¡£æ¡ˆUIçš„ï¼Œæœ‰è¯­éŸ³å’Œç«‹ç»˜åˆ‡æ¢çš„ï¼Œå’ŒAIèŠå¤©çš„ç³»ç»Ÿâ€å·²ç»å®Œå–„ï¼Œæ˜¯æ—¶å€™åšä¸€äº›å‰äººæ²¡æœ‰åšè¿‡çš„ä¸œè¥¿äº†ã€‚



åœ¨LingChat 0.4ï¼Œæˆ‘ä»¬å°†ä¼šä¸ºLingChatæ·»åŠ ä»¥ä¸‹åŠŸèƒ½ã€‚

- **é•¿çº¿å‰§æƒ…ç³»ç»Ÿ**ï¼šæ”¯æŒä½¿ç”¨ç±»ä¼¼galgameçš„å‰§æƒ…é¢„è®¾ï¼Œç›´æ¥å…¼å®¹ä¼ ç»Ÿgalgameçš„é¢„è®¾å‰§æœ¬å’Œåˆ†æ­§é€‰æ‹©ï¼ŒåŒæ—¶æ”¯æŒå°†ä¸€éƒ¨åˆ†ç”šè‡³å…¨éƒ¨çš„å‰§æƒ…**ç”±AIé©±åŠ¨**ã€‚ä½ å°†åœ¨å‰§æƒ…å†…æ—¥å¸¸çš„åœºåˆï¼Œåœä¸‹æ¥å’Œä¸»è§’è‡ªç”±çš„è°ˆå¿ƒï¼ŒèŠå¤Ÿäº†åœ¨ç»§ç»­å‰§æƒ…ï¼›ä½ å°†ä¸å†å±€é™äºç‚¹å‡»é€‰é¡¹æ¥é€‰æ‹©å‰§æƒ…åˆ†æ­§ï¼Œè€Œæ˜¯çœŸæ­£è¿›å…¥æ•…äº‹ï¼Œè¯´å‡ºä½ æƒ³è¯´çš„è¯ï¼Œå½±å“ä¸»è§’åšå‡ºé‡è¦é€‰æ‹©ï¼Œæˆ–è€…**åŠè¯´**ä¸»è§’çœŸæ­£çš„å›å¿ƒè½¬æ„ã€‚
- **å‰§æœ¬æ€/è·‘å›¢æ¨¡å¼**ï¼šæ”¯æŒä½¿ç”¨ç±»ä¼¼å‰§æœ¬æ€/è·‘å›¢æ¨¡å¼çš„å‰§æƒ…é¢„è®¾ï¼Œç”±ä¸€ä¸ªDMï¼ˆä¸»æŒäººï¼‰æ¥æŒæ§å‰§æƒ…çš„å‘å±•ï¼Œä½ å°†ä½“éªŒåˆ°è¯¸å¦‚éšç€æ—¶é—´çš„æ¨ç§»è·å¾—è¶Šæ¥è¶Šå¤šçš„ä¿¡æ¯ï¼Œåˆ¤æ–­â€œè°æ˜¯å‡¶æ‰‹â€ï¼Œç­‰ç±»å‰§æƒ…æ¸¸æˆ
- **éšæœºäº‹ä»¶ç”Ÿæˆå™¨**ï¼šè½»é‡åŒ–çš„å‰§æƒ…å¼•å¯¼ï¼Œå¦‚ä½ å’Œä½ çš„ocæ¢ç´¢åœ°ä¸‹è¿·å®«çš„è¿‡ç¨‹ä¸­ï¼Œç”±LLMç”Ÿæˆä½ ä»¬ä¸‹ä¸€ä¸ªæˆ¿é—´çš„è§é—»
- **å¤§é‡çš„é¢„è®¾å°æ¸¸æˆ**ï¼šå’Œä½ çš„ä¸€ä¸ªç”šè‡³å¤šä¸ªocäººè®¾ç©ä¸€æŠŠç‹¼äººæ€ï¼ŒçœŸå¿ƒè¯å¤§å†’é™©ï¼Œç”šè‡³æ¶é­”è½®ç›˜èµŒç­‰ç»å…¸äº’åŠ¨æ¸¸æˆ

è¿™äº›åŠŸèƒ½äº’ä¸å†²çªéœ€è¦ä¸€ä¸ªä»å¤´å¼€å§‹ç²¾å¿ƒè®¾è®¡çš„æ¡†æ¶ï¼Œæ‰€ä»¥è¿™äº›åŠŸèƒ½ä¸ä¼šé€æ¬¡æ›´æ–°ï¼Œè€Œæ˜¯åœ¨ä¸åœæ’æŸ¥å…¼å®¹æ€§è°ƒä¼˜åï¼Œè®¾è®¡ä¸€ä¸ªå…¼å®¹è¿™äº›æ‰€æœ‰æ¨¡å¼çš„æ ¸å¿ƒé€»è¾‘ï¼Œè®²è¿™äº›åŠŸèƒ½**ä¸€æ¬¡æ€§å…¨éƒ¨å®ç°**ã€‚

æˆ‘ä»¬è¿˜ä¼šç¼–å†™å¯è§†åŒ–å‰§æƒ…ç¼–è¾‘ç³»ç»Ÿï¼Œç¼–å†™è¯¦å°½çš„è¯´æ˜æ–‡ä»¶ï¼Œè®©æ‰€æœ‰äººå¯ä»¥ç¼–å†™å‡ºå±äºè‡ªå·±çš„ï¼Œå¯ä»¥å‚ä¸å…¶ä¸­çš„æ•…äº‹â€”â€”LingChat 0.4ï¼Œæ›´æ¥è¿‘äºä¸€ä¸ªâ€œå‰§æƒ…ç¼–è¾‘å™¨â€+â€œå‰§æƒ…æ¸²æŸ“å™¨â€ï¼Œæä¾›ä¸€ä¸ªAIæ—¶ä»£çš„å‰§æƒ…å±•ç°å¹³å°ã€‚

# äºŒï¼ŒYamlç»“æ„è®¾è®¡

åœ¨LingChat 0.4ï¼Œæˆ‘ä»¬å°†å®šä¹‰å¯å¯¼å…¥çš„å‰§æƒ…åŒ…çš„æ ‡å‡†æ ¼å¼ï¼Œåœ¨ç©å®¶ä¹‹é—´æˆ–è€…åˆ›æ„å·¥åŠä¼ æ’­ã€‚å‰§æƒ…åŒ…å°†ä¼šä½¿ç”¨.yamlçš„æ ¼å¼ç¼–å†™ã€‚

## Events

Eventsæ˜¯å‰§æƒ…æ–‡æœ¬ã€‚æˆ‘ä»¬æŠŠä¸€ä¸ªå‰§æƒ…æ–‡æœ¬æ°›å›´æ—ç™½ã€è§’è‰²å‘è¨€ã€ç©å®¶å‘è¨€å’Œå…¬å‘Šå››ç§ç±»å‹ã€‚åŒæ—¶æ¯ç§ç±»å‹éƒ½æ”¯æŒ`Preset`(é¢„è®¾)æ¨¡å¼å’Œ`Prompt`(æç¤ºè¯-llmé©±åŠ¨)æ¨¡å¼ã€‚ä»¥ä¸‹å†…å®¹å°†è¢«å†™å…¥txtæˆ–è€…yamlï¼Œä½œä¸ºå¯å¯¼å…¥çš„å‰§æƒ…åŒ…ï¼Œç„¶åè¢«pythonè§£æï¼Œç”¨äºé©±åŠ¨å‰§æƒ…ã€‚

### æ—ç™½

æ—ç™½ï¼Œæœ€åŸºç¡€çš„å‰§æƒ…æ¼”ç»æ–¹å¼ã€‚åœ¨LingChat 0.4ä¸­ï¼Œæˆ‘ä»¬ç»™å‡ºé¢„è®¾æ¨¡å¼å’Œæç¤ºè¯æ¨¡å¼ä¸¤ç§é€‰æ‹©ã€‚

```yaml
Events:
  - "Type: Narration | Mode: Preset": |
      æ”¾å­¦äº†ã€‚
  - "Type: Narration | Mode: Preset": |
      å¤•é˜³çš„ä½™æ™–é€è¿‡çª—æˆ·ï¼Œæ´’åœ¨ç©ºæ— ä¸€äººçš„æ•™å®¤é‡Œã€‚
```

æ³¨æ„ï¼Œç”±äºgalgameçš„æ€§è´¨ï¼Œæ¯æ¬¡åªæ˜¾ç¤ºä¸€è¡Œæ–‡æœ¬ï¼Œæ¯æ¬¡å›è½¦éƒ½ä¼šåˆ°ä¸‹ä¸€è¡Œï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦å®ç°å¤šè¡Œæ–‡æœ¬å’Œæ—ç™½æè¿°ï¼Œåº”è¯¥åˆ†æˆä¸¤æ¡`Narration`äº‹ä»¶ã€‚

```yaml
Events:
  - "Type: Narration | Mode: Prompt": |
      ä½ æ˜¯ä¸€ä¸ªè´Ÿè´£å‰§æƒ…è¡”æ¥çš„æ—ç™½ã€‚è¯·å‚è€ƒä¸Šè¿°å‰§æƒ…ï¼Œæè¿°{player_name}çœ‹ç€{AI_character_1}è½¬èº«ç¦»å»çš„èƒŒå½±ï¼Œåœ¨{time}çš„å¤œè‰²ä¸‹ï¼Œå¿ƒä¸­æ¶Œèµ·çš„ä¸€ä¸è«åçš„å¤±è½ä¸æ€…ç„¶ã€‚ä¸‰è¡Œå·¦å³ï¼Œæ¯è¡Œ20å­—ã€‚
```

å¯¹æç¤ºè¯æ¨¡å¼ç”Ÿæˆçš„å¤šè¡Œæ–‡æœ¬ï¼Œä¹Ÿåº”éµå®ˆgalgameçš„â€œå•è¡Œæ¸²æŸ“ï¼Œå›è½¦æ¢è¡Œâ€åŸåˆ™ã€‚

### è§’è‰²å‘è¨€

è§’è‰²å‘è¨€ï¼Œæ˜¯galgameçš„æ ¸å¿ƒå‰§æƒ…æ¼”ç»æ–¹å¼ã€‚åŒæ ·çš„ï¼Œæˆ‘ä»¬ç»™å‡ºé¢„è®¾æ¨¡å¼å’Œæç¤ºè¯æ¨¡å¼ä¸¤ç§é€‰æ‹©ï¼Œå¹¶ä¸”è€ƒè™‘åˆ°å¤šä¸ªé¢„è®¾è§’è‰²çš„å…¼å®¹æ€§ã€‚

```yaml
Events:
  - "Type: Dialogue | Character: {AI_character_1} | Mode: Preset": |
      æ—©ä¸Šå¥½å•Šï¼Œ{player_name}~ä»Šå¤©åˆæ˜¯æ²¡æœ‰å¹²åŠ²çš„ä¸€å¤©å‘
```

æ³¨æ„ï¼Œåœ¨å‘llmå‘é€è§’è‰²å¯¹è¯è¯·æ±‚æ—¶ï¼Œåº”è¯¥åŒºåˆ†æ¯ä¸ªAIè§’è‰²ï¼Œæ¯ä¸ªAIè§’è‰²éƒ½åº”è¯¥å¯ç”¨å¯¹åº”è§’è‰²çš„æç¤ºè¯ï¼Œå¹¶ä¸”è¯·æ±‚æ—¶ï¼ŒæŠŠè¯¥è§’è‰²çš„é¢„è®¾/ç”Ÿæˆçš„å¯¹è¯è®°å½•æ”¾å…¥`assistant_output`ï¼Œè€Œå…¶ä»–AIè§’è‰²åº”è¯¥æ”¾å…¥`user_input`å¹¶åœ¨å¼€å¤´å¢åŠ `è§’è‰²B:xxxx`

```yaml
Events:
  - "Type: Dialogue | Character: {AI_character_2} | Mode: Prompt": |
      è¿™æ˜¯ä½ çš„å†…å¿ƒæ´»åŠ¨ï¼šä½ å‡†å¤‡å‘{player_name}æ±‚åŠ©ï¼Œæ‰€ä»¥ä½ åº”è¯¥è®¨å¥½{player_name}
```

### ç©å®¶å‘è¨€

ä½œä¸ºgalgameï¼Œç©å®¶æœ‰è¢«å‰§æƒ…å›ºå®šçš„å¼ºåˆ¶å‘è¨€å½“ç„¶å¾ˆåˆç†ï¼Œå‰§æƒ…æ€å˜›ã€‚

```yaml
Events:
  - "Type: Player | Mode: Preset": |
      æˆ‘ä¸æƒ³å­¦ä¹ ï¼
```

å½“ç„¶ï¼Œæœ€æ ¸å¿ƒçš„æ˜¯ï¼Œå¯ä»¥è®©ç©å®¶æ‰“å­—è¾“å…¥ï¼Œç›´æ¥å’Œå‰§æƒ…äº¤äº’ï¼Œå­˜å…¥æ•´ä¸ªå¯¹è¯è®°å½•ä¸­ï¼Œå½±å“åç»­llmæ‰®æ¼”å…¶ä»–è§’è‰²çš„å‘è¨€ã€‚

```yaml
Events:
  - "Type: Player | Mode: Input": |
```

åœ¨æ¼”è¿›åˆ°è¿™ä¸ªé˜¶æ®µçš„æ—¶å€™ï¼Œä»£ç å°†ä¼šç­‰å¾…ç©å®¶è¾“å…¥ï¼Œç„¶åæ•²å›è½¦é”®å‘é€ã€‚

```yaml
Events:
  - "Type: Player | Mode: Input": |
      æˆ‘ä»¬èµ°å§~
```

è€ƒè™‘åˆ°æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æç¤ºä¸€ä¸‹ç©å®¶ï¼Œç»™ä¸ªå‚è€ƒï¼Œä»–ç°åœ¨å¤§æ¦‚éœ€è¦è¯´ä»€ä¹ˆï¼Œè¿™ä¸ªtypeä¹Ÿå¯ä»¥æ·»åŠ `Content`ã€‚

### å…¬å‘Š

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å¤šè¡Œæ–‡æœ¬ä»¥å¢åŠ ç©å®¶å¯è¯»æ€§ã€‚æ‰€ä»¥æˆ‘ä»¬å®šä¹‰`Notice`ã€‚

```yaml
Events:
  - "Type: Notice | Mode: Preset | Location: popup": |
      è¿™æ˜¯LingChatç‹¼äººæ€æ¨¡å¼ã€‚
      æ¸¸æˆè§„åˆ™æ˜¯ï¼šxxxxxxx
      ç©å¾—å¼€å¿ƒï¼
  - "Type: Notice | Mode: Prompt | Location: message": |
      ä½ æ˜¯ä¸€ä¸ªå‰§æœ¬æ€çš„DMï¼ˆä¸»æŒäººï¼‰ï¼Œè¯·æ ¹æ®ä»¥ä¸ŠèŠå¤©å†…å®¹æƒ…å†µï¼Œæ’­æŠ¥æ˜¨æ™šçš„æƒ…å†µã€‚
```

`Notice`æ˜¯å¤šè¡Œçš„ï¼Œå¹¶ä¸”é€šå¸¸ä¸åœ¨å¯¹è¯æ¡†å†…æ¸²æŸ“ï¼Œä»–å¯èƒ½æ˜¯å¼¹çª—çš„ï¼Œä¹Ÿå¯èƒ½æ˜¾ç¤ºåœ¨æŸä¸ªèƒŒæ™¯ä½ç½®ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨locationæ¥åŒºåˆ†Noticeçš„ç§ç±»ï¼Œå®šä¹‰Noticeå‡ºç°çš„ä½ç½®ï¼Œä¸å‰ç«¯è¿›è¡Œäº¤äº’ã€‚

### ç« èŠ‚

è€ƒè™‘åˆ°Eventsç›´æ¥æŒ‡å¯¼ç”ŸæˆèŠå¤©è®°å½•ï¼Œæˆ‘ä»¬æŠŠåˆ†ç« èŠ‚çš„åŠŸèƒ½å†™å…¥Eventsï¼Œåœ¨æ¼”è¿›åˆ°Events:Type: Chapteræ—¶ï¼Œåœ¨èŠå¤©è®°å½•å­˜æ¡£å†…æ³¨å…¥â€œç« èŠ‚â€çš„æ ‡è®°ï¼Œä»¥ä¾¿äºå‰ç«¯çš„åˆ†ç« èŠ‚æ¸²æŸ“ã€‚

```yaml
Events:
  - "Type: Chapter | Mode: Preset":
      Title: "ç¬¬ä¸€ç« ï¼šæ”¾å­¦åçš„é‚‚é€…"
      Number: 1 
      Description: "å¤•é˜³ä¸‹çš„æ ¡é—¨å£ï¼Œä¸€ä¸ªå¯»å¸¸å´åˆæ³¨å®šä¸å‡¡çš„ä¸‹åˆï¼Œæ•…äº‹å°±æ­¤å±•å¼€ã€‚"
```

### éšæ€§æ¡ä»¶

ä½¿ç”¨`Type: Action`åœ¨`gamestate.yaml`é‡Œæ“ä½œã€è®°å½•ã€å‚¨å­˜å˜é‡ï¼Œåœ¨promptä½¿ç”¨{å˜é‡å}è°ƒç”¨è¿™ä¸ªå˜é‡ã€‚

ä¾‹å¦‚ï¼Œåœ¨æŸä¸ªé€‰æ‹©æ­£ç¡®çš„æ”¯çº¿ï¼Œä½ å¯ä»¥æ’å…¥ä¸€ä¸ªActionï¼š

```yaml
Events:
- "Type: Action | Tool: Calculate | Variable: favorability_AI_character_1":
      Expression: "{favorability_AI_character_1} + 10"
```

ç„¶åä½ å¯ä»¥åœ¨prompté‡Œå†™ï¼š

```yaml
Events:
  - "Type: Dialogue | Character: {AI_character_2} | Mode: Prompt": |
      è¿™æ˜¯ä½ çš„å†…å¿ƒæ´»åŠ¨ï¼šå¬åˆ°{player_name}å‘ä½ è¡¨ç™½ï¼Œè€ƒè™‘åˆ°ä½ å¯¹ä»–ç°åœ¨çš„å¥½æ„Ÿåº¦æ˜¯{favorability_AI_character_1}(æœ€ä½ä¸º-100ï¼Œæœ€é«˜ä¸º100)ï¼Œä½ å†³å®šå¦‚ä½•å›ç­”ä»–å‘¢ï¼Ÿ
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥éšæœºå˜é‡ï¼Œæ¯”å¦‚è¿™æ ·å†™ï¼š

```yaml
Events:
  - "Type: Action | Tool: Random | Variable: dice_roll":
      Min: 1
      Max: 20
```

æˆ–è€…éšæœºå­—ç¬¦ä¸²ï¼š

```yaml
Events:
  - "Type: Action | Tool: RandomChoice | Variable: shotgun_status":
      Choices:
        - "éœ°å¼¹æªé‡Œæœ‰å­å¼¹"
        - "éœ°å¼¹æªé‡Œå­å¼¹å—æ½®äº†ï¼Œå¯èƒ½ä¼šå¡å£³"
        - "éœ°å¼¹æªé‡Œæ²¡æœ‰å­å¼¹"
        - "æªè†›æ˜¯ç©ºçš„ï¼Œä½†ä½ æ‘¸åˆ°å£è¢‹é‡Œè¿˜æœ‰ä¸€é¢—å¤‡ç”¨å¼¹"
```

å½“ç„¶ï¼Œå¸ƒå°”å€¼ä¹Ÿè¡Œã€‚

```yaml
Events:
  - "Type: Narration | Mode: Preset": |
      ä½ åœ¨ä¸€ä¸ªç”Ÿé”ˆçš„ç›’å­åº•ä¸‹æ‰¾åˆ°äº†åœ°ä¸‹å®¤çš„é’¥åŒ™ï¼
  - "Type: Action | Tool: Set | Variable: has_basement_key":
      Value: true
```

åœ¨ç¬¬ä¸€æ¬¡æ“ä½œçš„æ—¶å€™ä¼šè‡ªåŠ¨åœ¨`gamestate.yaml`åˆ›å»ºè¿™ä¸ªå˜é‡ï¼Œåç»­æ“ä½œä¼šç›´æ¥è¦†ç›–è¿™ä¸ªå˜é‡ã€‚å¦‚æœä½ å•çº¯æƒ³åˆå§‹åŒ–ç³»ç»Ÿï¼Œæˆ–è€…å¼ºè¡Œè®¾ç½®ä¸€ä¸ªï¼Œä½ å¯ä»¥ï¼š

```yaml
Events:
  - "Type: Action | Tool: Random | Variable: dice_roll":
      Min: 1
      Max: 1
```

æˆ–è€…

```yaml
Events:
  - "Type: Action | Tool: RandomChoice | Variable: shotgun_status":
      Choices:
        - "éœ°å¼¹æªè¢«è£…å…¥äº†å­å¼¹"
```

å½“ä½ çš„gamestate.yamlå†…éƒ¨å‚¨å­˜äº†ä¿¡æ¯ï¼Œåœ¨å†™promptæ—¶ï¼Œä¼šæŠŠå½“å‰çŠ¶æ€ä¼ å…¥promptã€‚

è¿™æ ·çš„è¯ï¼Œä½ å¯ä»¥è®¾å®šæŸäº›å¯¹è¯åªåœ¨é«˜å¥½æ„Ÿçš„æ—¶å€™è§¦å‘ï¼Œæ¯”å¦‚é«˜å¥½æ„Ÿä¸‹ä¼šæœ‰å½©è›‹è¡¨ç™½å¯¹è¯ï¼Œæˆ–è€…å®ç°é€»è¾‘åˆ¤æ–­ã€‚å½±å“å‰§æƒ…å¯¹è¯å¾ˆå¥½å†™ï¼Œæ¯”å¦‚è¿™æ ·å†™ï¼š

```yaml
Events:
  - "Type: Dialogue | Character: {AI_character_2} | Mode: Prompt": |
      è¿™æ˜¯ä½ çš„å†…å¿ƒæ´»åŠ¨ï¼šå¬åˆ°{player_name}å‘ä½ è¡¨ç™½ï¼Œè€ƒè™‘åˆ°ä½ å¯¹ä»–ç°åœ¨çš„å¥½æ„Ÿåº¦æ˜¯{favorability_AI_character_1}(æœ€ä½ä¸º-100ï¼Œæœ€é«˜ä¸º100)ï¼Œä½ å†³å®šå¦‚ä½•å›ç­”ä»–å‘¢ï¼Ÿ
```

å¤æ‚çš„å†™å°±å¯ä»¥è¿™æ ·å†™ï¼š

```yaml
Events:
  - "Type: Action | Tool: Random | Variable: dice_roll":
      Min: 1
      Max: 20

  - Condition: "{dice_roll} == 20"
    Events:
      - "Type: Narration | Mode: Preset": |
          éª°å­åœ¨æ¡Œé¢ä¸Šé£é€Ÿæ—‹è½¬ï¼Œæœ€ç»ˆåœåœ¨äº†â€œ20â€ï¼å¤§æˆåŠŸï¼
      - "Type: Narration | Mode: Preset": |
          ä½ æ„Ÿè§‰ä¸€è‚¡ç¥ç§˜çš„åŠ›é‡æ¶Œå…¥ä½“å†…ï¼
      - "Type: Action | Tool: Calculate | Variable: player_power":
          Expression: "{player_power} + 5"

  - Condition: "{dice_roll} > 1 && {dice_roll} < 20"
    Events:
      - "Type: Narration | Mode: Preset": |
          éª°å­åœäº†ä¸‹æ¥ï¼Œç‚¹æ•°æ˜¯ {dice_roll}ã€‚

  - Condition: "{dice_roll} == 1" # å¤§å¤±è´¥
    Events:
      - "Type: Narration | Mode: Preset": |
          ç³Ÿç³•ï¼éª°å­ç«Ÿç„¶æŠ•å‡ºäº†â€œ1â€ï¼å¤§å¤±è´¥ï¼
      - "Type: Narration | Mode: Preset": |
          ä½ è„šä¸‹ä¸€æ»‘ï¼Œæ‘”äº†ä¸ªå››è„šæœå¤©ã€‚
      - "Type: Action | Tool: Calculate | Variable: player_hp":
          Expression: "{player_hp} - 1"

  - Condition: "{has_basement_key} == true"
    Events:
      - "Type: Narration | Mode: Prompt": |
          ä½ ç°åœ¨æ‹¥æœ‰åœ°ä¸‹å®¤çš„é’¥åŒ™ï¼Œè¯·ç”Ÿæˆä¸€æ®µä½ å°è¯•ç”¨é’¥åŒ™æ‰“å¼€åœ°ä¸‹å®¤é—¨çš„æ—ç™½ã€‚
```

## EndCondition

æˆ‘ä»¬ä¼šå°†å¤§é‡çš„Eventså¯¹è¯å°è£…æˆä¸€ä¸ª.yamlæ–‡ä»¶ï¼Œç§°ä¹‹ä¸ºâ€œå‰§æƒ…å•å…ƒâ€ã€‚é‚£ä¹ˆæ¯ä¸ªå‰§æƒ…å•å…ƒä¹‹é—´äº’ç›¸è¿æ¥å°±å¯ä»¥å®ç°å¤šç»“å±€çš„å‰§æƒ…è®¾è®¡ã€‚

```mermaid
graph LR
    classDef default fill:#fff,stroke:#000,color:#000

    A[å‰§æƒ…å•å…ƒ1: æ”¾å­¦åæ•™å®¤.txt]-- çº¿æ€§è¿æ¥ --> B{å‰§æƒ…å•å…ƒ2: æ”¾å­¦åæ ¡é—¨å£.txt}

    B -- é€‰é¡¹A: å»è‡ªä¹ å®¤å¤ä¹  --> C[å‰§æƒ…å•å…ƒ3A: è‡ªä¹ å®¤å¤ä¹ .txt]
    B -- é€‰é¡¹B: åœ¨å®¶å¤ä¹  --> D[å‰§æƒ…å•å…ƒ3B: å®¶ä¸­å¤ä¹ .txt]

    B -. ç©å®¶æˆ–AIåšå‡ºé€‰æ‹© .-> B
```

å¦‚è¯¥å›¾ï¼Œè¿™æ ·è¿æ¥å°±å®ç°äº†å‰§æƒ…åˆ†æ­§ã€‚é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬å¼€å§‹å®šä¹‰EndConditionï¼Œå³åœ¨æ¯ä¸ªå‰§æƒ…å•å…ƒç»“å°¾ï¼Œå¦‚ä½•ä¸åç»­å‰§æƒ…è¿æ¥ã€‚

### çº¿æ€§è¿æ¥(`Linear`)

æœ€åŸºç¡€çš„çº¿æ€§è¿æ¥ï¼Œå½“ä¸€ä¸ªå‰§æƒ…å•å…ƒçš„.yamlæ–‡ä»¶çš„Eventsæ’­æ”¾å®Œæ¯•åï¼Œä½¿ç”¨`Linear`å³å¯è¿æ¥ä¸‹ä¸€ä¸ª.yamlå‰§æƒ…å•å…ƒï¼Œæ— ç¼çš„ç»§ç»­å‰§æƒ…ã€‚

```yaml
EndCondition:
  Type: Linear
  NextUnitID: SchoolGate_02
```

çº¿æ€§è¿æ¥æ— ç¼æ— æ„Ÿï¼Œæ˜¯åç»­å®ç°å¤æ‚çš„å‘ˆç°æ•ˆæœï¼Œå°±å¯ä»¥ç”¨å¤šä¸ªç‰¹æ®Šçš„çº¿æ€§è¿æ¥æ¥è¡”æ¥å‘ˆç°ã€‚

### è‡ªç”±æ—¶é—´ (`FreeTime`)

è°èƒ½æ‹’ç»åœ¨å†³æˆ˜å‰å¤•åœä¸‹æ¥å’Œä¸»è§’è‡ªç”±èŠå¤©ï¼ŒåŠ æ²¹æ‰“æ°”å‘¢ã€‚

```yaml
EndCondition:
  Type: FreeTime
  InstructionToPlayer: "ä½ å·²è¿›å…¥è‡ªç”±èŠå¤©æ—¶é—´ã€‚ç‚¹å‡»å³ä¸Šæ–¹æŒ‰é’®ï¼Œæˆ–è¾“å…¥åŒ…å«â€œæˆ‘å·²ç»å‡†å¤‡å¥½äº†â€çš„å¥å­å¯ç»“æŸè‡ªç”±èŠå¤©å¯¹è¯ã€‚"
  ExitPromptInInputBox: "æˆ‘å·²ç»å‡†å¤‡å¥½äº†"
  NextUnitID: ForestPath_05
```

è¿™æ ·å°±å¯ä»¥è®©ç©å®¶å¯ä»¥åœ¨ç‰¹å®šåœºæ™¯ä¸‹ä¸AIè‡ªç”±å¯¹è¯ï¼Œç›´åˆ°è§¦å‘ç»“æŸè¯­ã€‚

### é™å®šè½®æ¬¡è‡ªç”±æ—¶é—´ (`LimitedFreeTime`)

å½“ç„¶ï¼Œæœ‰æ—¶å€™å†³æˆ˜å‰æ—¶é—´ç´§è¿«ï¼Œä¸å¯èƒ½æ‚ å“‰æ‚ å“‰çš„æ°¸è¿œèŠä¸‹å»ã€‚

```yaml
EndCondition:
  Type: LimitedFreeTime
  MaxTurns: 3 # å®šä¹‰ç©å®¶ä¸AIè§’è‰²äº¤äº’çš„æœ€å¤§è½®æ¬¡ã€‚
  InstructionToPlayer: "ä½ å·²è¿›å…¥é™æ—¶è‡ªç”±èŠå¤©æ—¶é—´ã€‚ä½ æœ€å¤šå¯ä»¥å’Œ{AI_character_3}èŠ{MaxTurns} è½®ã€‚ç‚¹å‡»å³ä¸Šæ–¹æŒ‰é’®æˆ–è¾“å…¥åŒ…å«â€œæˆ‘å·²ç»å‡†å¤‡å¥½äº†â€çš„å¥å­å¯æå‰ç»“æŸã€‚"
  ExitPromptInInputBox: "æˆ‘å·²ç»å‡†å¤‡å¥½äº†"
  NextUnitID: ForestPath_05
```

è¿™æ ·å°±å¯ä»¥è®¾ç½®æœ€å¤§èŠå¤©è½®æ¬¡ã€‚

### åˆ†æ”¯ç»“å±€ (`Branching`)

è®©å‰§æƒ…æ ¹æ®ç©å®¶çš„é€‰æ‹©æˆ–AIçš„å†³å®šèµ°å‘ä¸åŒçš„é“è·¯ã€‚

å¯¹äºç»å…¸çš„galgameå‘ˆç°æ–¹å¼ï¼Œå³`Method: PlayerChoice`ï¼Œç»™å®šé€‰é¡¹ä½¿ç©å®¶é€‰æ‹©ï¼Œå½“ç„¶è¦æœ‰ã€‚

```yaml
EndCondition:
  Type: Branching
  Method: PlayerChoice
  Branches:
    A: 
      DisplayText: "ä¸Šå‰æ‰“ä¸ªæ‹›å‘¼"
      NextUnitID: Park_Encounter_05A
    B: 
      DisplayText: "è¿˜æ˜¯ä¸è¦æ‰“æ‰°å¥¹äº†ï¼Œæ‚„æ‚„ç¦»å¼€"
      NextUnitID: GoHome_Quietly_05B
    C: 
      DisplayText: "è£…ä½œæ²¡çœ‹è§ä»å¥¹å‰é¢ç»è¿‡"
      NextUnitID: Park_Encounter_05B
    ...
```

æŠŠé€‰æ‹©æƒç•™ç»™AIä¸»è§’ä¹Ÿä¸é”™ã€‚

```yaml
EndCondition:
  Type: Branching
  Method: AIChoice
  # ä¼šAIæ ¹æ®è¿™ä¸ªPromptï¼Œè¯´å‡ºè‡ªå·±çš„å†³å®š (ç©å®¶ä¸å¯è§)
  DecisionPromptForAI: "è¿™æ˜¯ä½ çš„å†…å¿ƒæ´»åŠ¨ï¼šç°åœ¨æ˜¯æ—¶å€™åšå‡ºå†³å®šäº†ã€‚ç»¼åˆåˆšæ‰å’Œ{player_name}çš„å¯¹è¯ï¼Œä»¥åŠä»–å¯¹ä½ é‚€è¯·çš„å›åº”ï¼Œæ˜ç¡®å‘Šè¯‰ä»–ï¼Œä½ æœ€ç»ˆå†³å®š'ä¸€èµ·å»è‡ªä¹ å®¤'è¿˜æ˜¯'å…ˆå„è‡ªå›å®¶'å¤ä¹ ã€‚"

  # ç³»ç»Ÿåå°æ ¹æ®AIè¯´çš„è¯ï¼Œè¿›è¡Œåˆ¤æ–­ (ç©å®¶ä¸å¯è§)
  JudgePromptForSystem: |
    ä½ æ˜¯AI-galgameçš„å‰§æƒ…åŠ©æ‰‹ã€‚è¯·æ ¹æ®èŠå¤©è®°å½•ï¼Œåˆ¤æ–­{AI_character_3}æ˜¯æ‰“ç®— A:å»è‡ªä¹ å®¤å­¦ä¹  è¿˜æ˜¯ B:åœ¨å®¶å­¦ä¹ ã€‚
    ä½ åªèƒ½è¾“å‡º'A'æˆ–'B'ï¼Œæ— éœ€ä»»ä½•å…¶ä»–è§£é‡Šã€‚
    
  # 3. æ ¹æ®åˆ¤æ–­ç»“æœ(Aæˆ–B)ï¼Œè·³è½¬åˆ°ä¸åŒå‰§æƒ…
  Branches:
    A: Library_03A
    B: GoHome_03B
```

åšå‡ºé€‰æ‹©ä¹‹åå°†ä¼šç›´æ¥è·³åˆ°ä¸‹ä¸€ä¸ªå‰§æƒ…å•å…ƒã€‚å¦‚æœä½ æƒ³è¦æœ‰æ—ç™½æˆ–è€…ä»€ä¹ˆæç¤ºæ¥æç¤ºè¯´æ˜ä½ çš„é€‰æ‹©å’Œä½ çš„å‰§æƒ…çº¿ï¼Œé‚£å°±åœ¨è¿æ¥çš„ä¸‹ä¸€ä¸ªå‰§æƒ…å•å…ƒçš„å¼€å¤´å†™noticeæˆ–è€…æ—ç™½ã€‚

### æ¡ä»¶ç»“å±€(`Conditional `)

æœ‰äº†éšå¼å˜é‡ï¼Œè‡ªç„¶å¯ä»¥åšå‡ºé€šè¿‡å­˜æ¡£ä¿å­˜çš„éšå¼å˜é‡æ¥å†³å®šç»“å±€ã€‚

```yaml
EndCondition:
  Type: Conditional
  # Casesä¼šæŒ‰é¡ºåºæ£€æŸ¥ï¼Œé‡åˆ°ç¬¬ä¸€ä¸ªä¸ºTrueçš„Conditionå³æ‰§è¡Œï¼Œç„¶åç»“æŸ
  Cases:
    - Condition: "{favorability_AI_character_1} >= 80 && {has_love_letter} == true"
      Then:
        Type: Linear
        NextUnitID: Confession_Success_10A

    - Condition: "{favorability_AI_character_1} >= 50"
      Then:
        Type: FreeTime
        InstructionToPlayer: "å¥¹çœ‹èµ·æ¥å¯¹ä½ å¾ˆæœ‰å¥½æ„Ÿï¼Œä¼¼ä¹æƒ³å’Œä½ å¤šèŠä¸€ä¼šå„¿ã€‚è¾“å…¥â€œå†è§â€ç»“æŸå¯¹è¯ã€‚"
        ExitPromptInInputBox: "å†è§"
        NextUnitID: FriendZone_Date_10B
        
  # å¦‚æœä»¥ä¸Šæ‰€æœ‰Casesçš„Conditionéƒ½ä¸ºFalseï¼Œåˆ™æ‰§è¡ŒElseä¸­çš„ç»“å±€
  Else:
    Type: Linear
    NextUnitID: Normal_Ending_10C
```



## SceneConfig

å®šä¹‰å•ä¸ªå‰§æƒ…å•å…ƒå†…çš„å…¨å±€å˜é‡ï¼Œç”¨äºä¸å…¶ä»–æ¨¡å—é€šä¿¡ç­‰ï¼Œå¦‚è®©å‰ç«¯çŸ¥é“åœ¨è¿™ä¸ªåœºæ™¯ä¸‹è¯¥ç”¨ä»€ä¹ˆèƒŒæ™¯å›¾ç‰‡

```yaml
SceneConfig:
  id: "SchoolGate_01"
  name: "æ”¾å­¦åçš„æ ¡é—¨å£"
  description: "å¤•é˜³ä¸‹çš„æ ¡é—¨å£ï¼Œå­¦ç”Ÿä»¬é™†ç»­ç¦»å»ï¼Œä¸€åˆ‡éƒ½æ˜¾å¾—é‚£ä¹ˆå¹³é™è€Œç¾å¥½ã€‚"
  tags: ["school", "slice-of-life", "evening"]
  
  visuals:
    background_image: "bg_school_gate_sunset.png"
  audio:
    background_music: "bgm_school_farewell.mp3"
    music_volume: 0.7
```

## å‰§æƒ…å•å…ƒç¤ºæ„

æœ€åï¼Œä¸€ä¸ªå®Œæ•´çš„yamlå‰§æƒ…å•å…ƒå·®ä¸å¤šä¼šé•¿è¿™ä¸ªæ ·å­ï¼š

```yaml
SceneConfig:
  id: "Classroom_01"
  name: "æ”¾å­¦å"
  description: "å¤•é˜³ä¸‹æ•™å®¤ï¼Œä¸€åˆ‡éƒ½æ˜¾å¾—é‚£ä¹ˆå¹³é™è€Œç¾å¥½ã€‚ä¼šæœ‰ä»€ä¹ˆæ•…äº‹å‘ç”Ÿå‘¢ï¼Ÿ"
  tags: ["school", "slice-of-life", "evening"]
  
  visuals:
    background_image: "bg_school_classroom_sunset.png"
  audio:
    background_music: "bgm_school_farewell.mp3"
    music_volume: 0.7
    
Events:
  - "Type: Chapter | Mode: Preset":
      Title: "ç¬¬ä¸€ç« ï¼šæ”¾å­¦åçš„é‚‚é€…"
      Number: 1 
      Description: "å¤•é˜³ä¸‹çš„æ•™å®¤ï¼Œä¸€ä¸ªå¯»å¸¸å´åˆæ³¨å®šä¸å‡¡çš„ä¸‹åˆï¼Œæ•…äº‹å°±æ­¤å±•å¼€ã€‚"
  - "Type: Narration | Mode: Preset": |
      æ”¾å­¦äº†ã€‚
  - "Type: Narration | Mode: Preset": |
      å¤•é˜³çš„ä½™æ™–é€è¿‡çª—æˆ·ï¼Œæ´’åœ¨ç©ºæ— ä¸€äººçš„æ•™å®¤é‡Œã€‚
  - "Type: Narration | Mode: Preset": |
      åªå‰©ä¸‹æˆ‘å’Œ{AI_character_1}ä¸¤ä¸ªäººè¿˜åœ¨æ…¢åååœ°æ”¶æ‹¾ç€ä¹¦åŒ…ã€‚
  - "Type: Dialogue | Character: {AI_character_1} | Mode: Preset": |
      å‘¼...ç»ˆäºå¼„å®Œäº†ã€‚ä»Šå¤©å€¼æ—¥è¿˜çœŸæ˜¯æœ‰ç‚¹ç´¯å‘¢ã€‚
  - "Type: Player | Mode: Input": |
  - "Type: Dialogue | Character: {AI_character_2} | Mode: Prompt": |
      è¿™æ˜¯ä½ çš„å†…å¿ƒæ´»åŠ¨ï¼šå¬äº†{player_name}çš„å›åº”ï¼Œä½ æ„Ÿè§‰å¿ƒæƒ…æ”¾æ¾äº†ä¸€äº›ã€‚ä½†ä¸€æƒ³åˆ°ä¸‹å‘¨å°±è¦è€ƒè¯•äº†ï¼Œåˆæ„Ÿåˆ°ä¸€é˜µç„¦è™‘ã€‚ä½ æ‰“ç®—èŠäº›è€ƒè¯•çš„è¯é¢˜ã€‚
  - "Type: Player | Mode: Input": |

EndCondition:
  Type: FreeTime
  InstructionToPlayer: "ä½ å·²è¿›å…¥è‡ªç”±èŠå¤©æ—¶é—´ã€‚ç‚¹å‡»å³ä¸Šæ–¹æŒ‰é’®ï¼Œæˆ–è¾“å…¥åŒ…å«â€œæˆ‘ä»¬èµ°å§â€çš„å¥å­å¯ç»“æŸè‡ªç”±èŠå¤©å¯¹è¯ã€‚"
  ExitPromptInInputBox: "æˆ‘ä»¬èµ°å§"
  NextUnitID: SchoolGate_01
```

## éšæ€§æ¡ä»¶ç¤ºæ„

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŒºåŸŸå‚¨å­˜éšæ€§çš„æ¸¸æˆçŠ¶æ€ï¼Œå¦‚ï¼š

- å½“å‰è§’è‰²å¯¹ä¸»è§’çš„å¥½æ„Ÿåº¦
- è¿™æ¬¡æ¶é­”è½®ç›˜èµŒä¸­ï¼Œæªé‡Œæœ‰æ²¡æœ‰å­å¼¹

æˆ‘ä»¬å°†å…¶å‚¨å­˜åœ¨`gamestate.yaml`ä¸­ï¼Œåœ¨å‰§æœ¬çš„åˆå§‹å°±åº”è¯¥ç»™å‡ºåˆå§‹`gamestate.yaml`ã€‚

```yaml
# gamestate.yaml
player_name: "Sensei"
current_time: "é»„æ˜"

# è§’è‰²å¥½æ„Ÿåº¦
favorability_AI_character_1: 25
favorability_AI_character_2: 60

# å‰§æƒ…æ ‡å¿— (Flags)
has_basement_key: false
completed_prologue: true
is_rival_angry: false

# èµ„æº/æ•°å€¼
player_hp: 100
gold: 500
dice_roll_result: 15
shotgun_status: "æªè†›æ˜¯ç©ºçš„ï¼Œä½†ä½ æ‘¸åˆ°å£è¢‹é‡Œè¿˜æœ‰ä¸€é¢—å¤‡ç”¨å¼¹"
```

# ä¸‰ï¼Œå¤šyamlè¿æ¥

ä¸ºä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å„ç§æ¨¡å¼ä¸‹éƒ½ä½¿ç”¨åŒä¸€å¥—é€»è¾‘ç³»ç»Ÿã€‚å¦‚æƒ³å¯åŠ¨æ­£å¸¸çš„è‡ªç”±å¯¹è¯æ¨¡å¼ï¼Œå¯ä»¥è½½å…¥ä¸€ä¸ªæ— ä»»ä½•é¢„è®¾ï¼Œè‡ªç”±æ—¶é—´ç»“å±€å¹¶ä¸è‡ªå·±è¿æ¥çš„yamlå‰§æœ¬å³å¯ã€‚åœ¨Yamlç»“æ„è®¾è®¡éƒ¨åˆ†ï¼Œæˆ‘ä»¬è®¨è®ºäº†å¦‚ä½•è®¾è®¡ä»¥æ¨è¿›AI-galgameï¼Œä¸‹é¢æˆ‘ä»¬è®¨è®ºå…¶ä»–åœºæ™¯ä¸‹çš„å‰§æœ¬é¢„è®¾æ–¹æ³•ã€‚

## å¾ªç¯é“¾æ¥

yamlä¹‹é—´å¯ä»¥é¦–ä½ç›¸æ¥ç»„æˆå¾ªç¯ï¼Œè¿™æ ·å°±èƒ½äº§ç”Ÿæ— å°½çš„å‰§æœ¬ã€‚

å¦‚æœä½ æƒ³å†™ä¸€ä¸ªæ¢ç´¢åœ°ä¸‹è¿·å®«çš„æ— å°½å‰§æƒ…ï¼Œä½ å¯ä»¥è¿™æ ·è®¾è®¡ï¼š

```mermaid
graph TD
    classDef default fill:#fff,stroke:#000,color:#000

    A[å‰§æƒ…å•å…ƒA]
    B[å‰§æƒ…å•å…ƒB]
    C[å‰§æƒ…å•å…ƒC]

    A -- "è‡ªç”±æ—¶é—´ / é™è½®æ¬¡è‡ªç”±æ—¶é—´" --> B
    B -- "è‡ªç”±æ—¶é—´ / é™è½®æ¬¡è‡ªç”±æ—¶é—´" --> C
    C -- "è‡ªç”±æ—¶é—´ / é™è½®æ¬¡è‡ªç”±æ—¶é—´" --> A
```

å°†å¤šä¸ªå‰§æƒ…å•å…ƒé¦–å°¾ç›¸æ¥ï¼Œåœ¨å‰§æƒ…å•å…ƒçš„å¼€å¤´å†™ä¸Šï¼š

```yaml
Events:
  - "Type: Narration | Mode: Prompt": |
      ä½ æ˜¯è´Ÿè´£æ¨è¿›å‰§æƒ…çš„AIåŠ©æ‰‹ï¼Œè¯·æ ¹æ®å‰é¢æ‰€æœ‰çš„å†å²å¯¹è¯ï¼Œåˆ›å»ºä»–ä»¬è¿›å…¥çš„ä¸‹ä¸€ä¸ªè¿·å®«ä¼šçœ‹åˆ°çš„åœºæ™¯ï¼Œç”¨æ—ç™½çš„è¯­è¨€æè¿°å‡ºæ¥ã€‚
```

è¿™æ ·å°±å¯ä»¥æ— é™åˆ›å»ºæ–°çš„è¿·å®«ç”¨æ¥æ¢ç´¢ã€‚

å½“ç„¶ï¼Œå¯¹äºä¸€ä¸ªæ–­æ¡ˆå‰§æœ¬æ¥è¯´ï¼Œå¯ä»¥è¿™æ ·è®¾è®¡ï¼š

```mermaid
graph LR
    classDef default fill:#fff,stroke:#000,color:#000

    S1[æ•…äº‹]
    S2[æ•…äº‹]
    A[å‰§æƒ…å•å…ƒA]
    B[å‰§æƒ…å•å…ƒB]
    C[å‰§æƒ…å•å…ƒC]
    P[åˆ¤å®š]
    E[ç»“å±€]

    S1 -- "çº¿æ€§" --> S2
    S2 -- "çº¿æ€§" --> A
    A -- "è‡ªç”±æ—¶é—´ / é™è½®æ¬¡" --> B
    B -- "è‡ªç”±æ—¶é—´ / é™è½®æ¬¡" --> C
    C -- "è‡ªç”±æ—¶é—´ / é™è½®æ¬¡" --> P
    P -- "æˆåŠŸ"--> E
    P -- "å¤±è´¥"--> A
```

å°†ç®€å•çš„å‰§æƒ…å•å…ƒä¾æ¬¡é“¾æ¥ï¼Œå°±å¯ä»¥å®Œæˆå¤æ‚çš„å‰§æœ¬ä»»åŠ¡ã€‚

# å››ï¼Œå‚¨å­˜ç»“æ„ä¸å­˜æ¡£

## å‚¨å­˜ç»“æ„

```
å‰§æœ¬æ–‡ä»¶/
â”œâ”€â”€ save/
â”‚   â””â”€â”€ gamestate.yaml
â”œâ”€â”€ character/        #å¯å¯¼å…¥å¤–éƒ¨ç©å®¶ocå¯¹åº”æ¯ä¸ªâ€œè§’è‰²ä½ç½®â€ï¼Œä¹Ÿå¯ç›´æ¥åŒ…å«åœ¨å‰§æœ¬åŒ…ã€‚å»ºè®®ä½¿ç”¨é»˜è®¤+è¦†ç›–çš„ç»“æ„
â”‚   â”œâ”€â”€ AIè§’è‰²A.yaml
â”‚   â”œâ”€â”€ AIè§’è‰²B.yaml
â”‚   ...
â”‚   â””â”€â”€ ç©å®¶äººè®¾.yaml
â”œâ”€â”€ story/
â”‚   â”œâ”€â”€ å‰§æƒ…_01.yaml
â”‚   â”œâ”€â”€ å‰§æƒ…_02.yaml
â”‚   ...
â”‚   â””â”€â”€ å‰§æƒ…_ç»“å±€.yaml
â”œâ”€â”€ å…¨å±€å‰§æƒ…é…ç½®.yaml
â””â”€â”€ å‰§æƒ…ä»‹ç».md
```

å½“æ¸¸æˆå¼€å§‹æ—¶ï¼Œä¾ç…§å‰§æƒ…åŒ…ç”Ÿæˆä¸€ä¸ªå­˜æ¡£æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ªå®Œæ•´çš„å‰§æƒ…å®šä¹‰å’Œå®ç°ï¼›ç„¶åé€šè¿‡è®°å½•å‰§æœ¬æ¼”è¿›çŠ¶æ€æ¥å®ç°å­˜æ¡£å’Œè¯»æ¡£ï¼Œè¿™æ ·å…¼å®¹æ™®é€šå¯¹è¯ï¼Œgalgameå‰§æƒ…ï¼Œç‹¼äººæ€å‰§æƒ…ç­‰æ‰€æœ‰å‰§æƒ…ï¼ŒåŒºåˆ«åªæ˜¯åŠ è½½å“ªä¸ªå‰§æƒ…åŒ…

```
å­˜æ¡£æ–‡ä»¶/              #ä¸€ä¸ªå¯¹è¯å¼€å§‹æ—¶ï¼Œä»å‰§æœ¬æ–‡ä»¶å’Œè§’è‰²æ–‡ä»¶ç”Ÿæˆä¸€ä¸ªå­˜æ¡£æ–‡ä»¶ï¼ŒåŒ…å«ä¸€ä¸ªé€»è¾‘å®Œæ•´çš„ï¼Œå¯ç›´æ¥è¿ä½œçš„äººè®¾å’Œå‰§æœ¬ï¼Œæ”¯æŒå­˜æ¡£å’Œè¯»æ¡£
â”œâ”€â”€ save/
â”‚   â”œâ”€â”€ æ¸¸æˆè¿›åº¦.yaml
â”‚   â”œâ”€â”€ gamestate.yaml
â”‚   â””â”€â”€ å¯¹è¯è®°å½•.yaml
â”œâ”€â”€ character/
â”‚   â”œâ”€â”€ AIè§’è‰²A.yaml
â”‚   â”œâ”€â”€ AIè§’è‰²B.yaml
â”‚   ...
â”‚   â””â”€â”€ ç©å®¶äººè®¾.yaml
â”œâ”€â”€ story/
â”‚   â”œâ”€â”€ å‰§æƒ…_01.yaml
â”‚   â”œâ”€â”€ å‰§æƒ…_02.yaml
â”‚   ...
â”‚   â””â”€â”€ å‰§æƒ…_ç»“å±€.yaml
â”œâ”€â”€ å…¨å±€å‰§æƒ…é…ç½®.yaml
â””â”€â”€ å‰§æƒ…ä»‹ç».yaml
```

æ³¨æ„ï¼Œå‰§æƒ…yamlå’Œè§’è‰²yamlæ˜¯åˆ†ç¦»çš„ï¼Œè§’è‰²yamlæ˜¯å¯ä»¥æ¢æˆç”¨æˆ·è‡ªå·±å–œæ¬¢çš„ocçš„ï¼Œæ‰€ä»¥åœ¨ç¼–å†™promptçš„æ—¶å€™ï¼Œç¼–å†™åŸåˆ™æ˜¯ï¼Œåªèƒ½ç¼–å†™èƒŒæ™¯Promptï¼Œä¸èƒ½æ··å…¥äººç‰©promptã€‚

## è¯»æ¡£å­˜æ¡£

ä½¿ç”¨æ¯æ¬¡äº‹ä»¶éƒ½ä¼šæ›´æ–°çš„æ¸¸æˆè¿›åº¦.yamlæ¥ä¿å­˜å’Œè¯»å–æ¸¸æˆå­˜æ¡£ã€‚

```yaml
# æ¸¸æˆè¿›åº¦.yaml
# æè¿°äº†æ¸¸æˆçš„æ ¸å¿ƒè¿›åº¦å’Œå½“å‰æ‰€å¤„çš„çŠ¶æ€ã€‚

# --- å…ƒæ•°æ® ---
save_name: "åˆé‡åçš„å‚æ™š"
story_pack_id: "lingchat-sunset-promise-v1" # ç”¨äºæ ¡éªŒå’Œåˆ›æ„å·¥åŠè¯†åˆ«
last_saved_timestamp: "2023-10-27T18:30:05Z"

# --- æ ¸å¿ƒè¿›åº¦æŒ‡é’ˆ ---
# ç²¾ç¡®æŒ‡å‘æœ€åå®Œæˆçš„äº‹ä»¶ä½ç½®ã€‚
progress_pointer:
  # å½“å‰æ‰€åœ¨çš„å‰§æƒ…å•å…ƒIDï¼Œå¯¹åº” story/ ç›®å½•ä¸‹çš„æ–‡ä»¶åï¼ˆä¸å«.yamlï¼‰
  current_unit_id: "Classroom_01" 
  
  # æœ€å*å·²å®Œæˆ*çš„äº‹ä»¶åœ¨å½“å‰å‰§æƒ…å•å…ƒEventsåˆ—è¡¨ä¸­çš„ç´¢å¼•ï¼ˆ0-basedï¼‰ã€‚
  # -1 è¡¨ç¤ºè¯¥å•å…ƒåˆšå¼€å§‹ï¼Œè¿˜æœªæ‰§è¡Œä»»ä½•äº‹ä»¶ã€‚
  # åŠ è½½æ—¶ï¼Œç³»ç»Ÿå°†ä» last_completed_event_index + 1 å¼€å§‹æ‰§è¡Œã€‚
  last_completed_event_index: 5 

# --- è¿è¡Œæ—¶çŠ¶æ€ ---
# æè¿°æ¸¸æˆå¼•æ“åœ¨åŠ è½½æ­¤å­˜æ¡£ååº”è¯¥åšä»€ä¹ˆã€‚è¿™æ˜¯é¿å…bugçš„å…³é”®ã€‚
# å¯èƒ½çš„å€¼:
#  - ExecutingEvents: æ­£å¸¸æŒ‰é¡ºåºæ‰§è¡ŒEventsåˆ—è¡¨ã€‚
#  - WaitingForPlayerInput: æš‚åœï¼Œç­‰å¾…ç©å®¶è¾“å…¥æ–‡æœ¬ã€‚(å¯¹åº” Type: Player | Mode: Input)
#  - InFreeTime: å¤„äºè‡ªç”±å¯¹è¯æ¨¡å¼ï¼Œç­‰å¾…ç©å®¶è¾“å…¥æˆ–è§¦å‘é€€å‡ºè¯­ã€‚
#  - WaitingForPlayerChoice: æš‚åœï¼Œå‘ç©å®¶æ˜¾ç¤ºåˆ†æ”¯é€‰é¡¹å¹¶ç­‰å¾…é€‰æ‹©ã€‚(å¯¹åº” EndCondition: Branching | Method: PlayerChoice)
#  - ProcessingAIChoice: ç³»ç»Ÿåå°æ­£åœ¨è¿è¡ŒAIå†³ç­–ï¼Œå‰ç«¯ç­‰å¾…ç»“æœã€‚(å¯¹åº” EndCondition: Branching | Method: AIChoice)
runtime_state: "WaitingForPlayerInput"
```

åœ¨å¤„äºè‡ªç”±å¯¹è¯çš„æ—¶å€™ï¼Œç¡¬åšç‰¹æ®Šå…¼å®¹æ€§å¤„ç†ã€‚

```yaml
# æ¸¸æˆè¿›åº¦.yaml

# --- å…ƒæ•°æ® ---
save_name: "å’Œç”±çºªçš„è¯¾åé—²èŠ"
story_pack_id: "lingchat-yuki-afterschool-v1.0"
last_saved_timestamp: "2023-10-28T16:45:10Z"

# --- æ ¸å¿ƒè¿›åº¦æŒ‡é’ˆ ---
# ç²¾ç¡®æŒ‡å‘æœ€åå®Œæˆçš„äº‹ä»¶ä½ç½®ã€‚
progress_pointer:
  # å½“å‰æ‰€åœ¨çš„å‰§æƒ…å•å…ƒæ˜¯ Classroom_AfterSchool_01
  current_unit_id: "Classroom_AfterSchool_01" 
  
  # è¯¥å‰§æƒ…å•å…ƒä¸­æ‰€æœ‰é¢„è®¾çš„Eventséƒ½å·²æ‰§è¡Œå®Œæ¯•ã€‚
  # å‡è®¾è¯¥å•å…ƒæœ‰4ä¸ªé¢„è®¾äº‹ä»¶ (ç´¢å¼• 0, 1, 2, 3)ï¼Œé‚£ä¹ˆæœ€åä¸€ä¸ªå®Œæˆçš„ç´¢å¼•æ˜¯3ã€‚
  # ç³»ç»Ÿå·²è¿›å…¥EndConditioné˜¶æ®µã€‚
  last_completed_event_index: 3 

# --- è¿è¡Œæ—¶çŠ¶æ€ ---
# è¿™æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œå®ƒå‘Šè¯‰ç³»ç»Ÿè¯»æ¡£åè¯¥åšä»€ä¹ˆã€‚
# "InFreeTime" æ˜ç¡®æŒ‡ç¤ºå¼•æ“ï¼šä¸è¦å†å»æ‰§è¡ŒEventsåˆ—è¡¨ï¼Œè€Œæ˜¯æ¿€æ´»è‡ªç”±èŠå¤©/é™æ—¶è‡ªç”±èŠå¤©çš„é€»è¾‘ã€‚
runtime_state: "InFreeTime"

# --- çŠ¶æ€ç‰¹å®šæ•°æ®  ---
# ç”±äº runtime_state æ˜¯ "InFreeTime"ï¼Œä¸”åŸå§‹ EndCondition æ˜¯ LimitedFreeTimeï¼Œ
# ç³»ç»Ÿä¼šè®°å½•å¹¶æ¢å¤è¿™ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
limited_free_time_context:
  # å·²ç»å®Œæˆçš„å¯¹è¯è½®æ¬¡ï¼ˆ1è½® = ç©å®¶è¯´1å¥ + AIè¯´1å¥ï¼‰ã€‚
  turns_taken: 1
  # ä» EndCondition ä¸­è¯»å–çš„æ€»è½®æ¬¡é™åˆ¶ï¼Œæ–¹ä¾¿æ¢å¤æ—¶ç›´æ¥ä½¿ç”¨ã€‚
  max_turns: 3
```



## å¯¹è¯è®°å½•

å¯¹è¯è®°å½•æ˜¯RAGç³»ç»Ÿè¿è½¬å’ŒLLMè¿è½¬çš„æ ¸å¿ƒï¼Œå¾ˆå¤šå·¥ä½œå°†ä¼šåŸºäºå¯¹è¯è®°å½•è¿›è¡Œã€‚

```yaml
# å¯¹è¯è®°å½•.yaml
# è®°å½•äº†æ‰€æœ‰å·²å‘ç”Ÿçš„å¯¹è¯ã€æ—ç™½ç­‰ã€‚

# --- é¢„è®¾å‰§æƒ…äº‹ä»¶çš„è®°å½• ---
- id: "evt_001"
  timestamp: "2023-10-28T16:40:01Z"
  source_unit_id: "Classroom_AfterSchool_01"
  source_event_index: 0 # å¯¹åº”Eventsåˆ—è¡¨çš„ç¬¬0ä¸ªäº‹ä»¶
  type: "Narration"
  content: "å¤•é˜³çš„ä½™æ™–é€è¿‡çª—æˆ·ï¼Œæ´’åœ¨ç©ºæ— ä¸€äººçš„æ•™å®¤é‡Œã€‚"

- id: "evt_002"
  timestamp: "2023-10-28T16:40:15Z"
  source_unit_id: "Classroom_AfterSchool_01"
  source_event_index: 1 # å¯¹åº”Eventsåˆ—è¡¨çš„ç¬¬1ä¸ªäº‹ä»¶
  type: "Narration"
  content: "åªå‰©ä¸‹æˆ‘å’Œæœˆè§ä¸¤ä¸ªäººè¿˜åœ¨æ…¢åååœ°æ”¶æ‹¾ç€ä¹¦åŒ…ã€‚"

- id: "evt_003"
  timestamp: "2023-10-28T16:40:40Z"
  source_unit_id: "Classroom_AfterSchool_01"
  source_event_index: 2 # å¯¹åº”Eventsåˆ—è¡¨çš„ç¬¬2ä¸ªäº‹ä»¶
  type: "Dialogue"
  character_id: "AI_character_1" # ç”±çºª
  content: "å‘¼...ç»ˆäºå¼„å®Œäº†ã€‚ä»Šå¤©å€¼æ—¥è¿˜çœŸæ˜¯æœ‰ç‚¹ç´¯å‘¢ã€‚"

- id: "evt_004"
  timestamp: "2023-10-28T16:41:20Z"
  source_unit_id: "Classroom_AfterSchool_01"
  source_event_index: 3 # å¯¹åº”Eventsåˆ—è¡¨çš„ç¬¬3ä¸ªäº‹ä»¶
  type: "Player"
  content: "æ˜¯å•Šï¼Œè¾›è‹¦äº†ã€‚" # ç©å®¶çš„è¾“å…¥

# --- EndConditionè§¦å‘ï¼Œè¿›å…¥è‡ªç”±èŠå¤©åçš„è®°å½• ---

- id: "evt_005"
  timestamp: "2023-10-28T16:41:25Z"
  source_unit_id: "Classroom_AfterSchool_01"
  # source_event_index ä¸º nullï¼Œè¡¨ç¤ºè¿™ä¸æ˜¯æ¥è‡ªé¢„è®¾Eventsåˆ—è¡¨ï¼Œè€Œæ˜¯ç”±ç³»ç»Ÿï¼ˆå¦‚EndConditionï¼‰ç”Ÿæˆçš„ã€‚
  source_event_index: null 
  type: "Notice"
  data:
    location: "popup" # å‡è®¾è¿™æ˜¯å¼¹çª—æç¤º
    content: "ä½ å·²è¿›å…¥é™æ—¶è‡ªç”±èŠå¤©æ—¶é—´ã€‚ä½ æœ€å¤šå¯ä»¥å’Œç”±çºªèŠ3è½®ã€‚ç‚¹å‡»å³ä¸Šæ–¹æŒ‰é’®æˆ–è¾“å…¥åŒ…å«â€œæˆ‘ä»¬èµ°å§â€çš„å¥å­å¯æå‰ç»“æŸã€‚"

# --- ç¬¬ä¸€è½®è‡ªç”±å¯¹è¯ ---
- id: "evt_006"
  timestamp: "2023-10-28T16:43:00Z"
  source_unit_id: "Classroom_AfterSchool_01"
  # indexåŒæ ·ä¸ºnullï¼Œè¡¨ç¤ºæ˜¯è‡ªç”±ç”Ÿæˆçš„ç©å®¶è¾“å…¥
  source_event_index: null
  type: "Player"
  content: "è¯´èµ·æ¥ï¼Œä¸‹å‘¨çš„è€ƒè¯•ä½ å‡†å¤‡å¾—æ€ä¹ˆæ ·äº†ï¼Ÿ"

- id: "evt_007"
  timestamp: "2023-10-28T16:44:12Z"
  source_unit_id: "Classroom_AfterSchool_01"
  # indexåŒæ ·ä¸ºnullï¼Œè¡¨ç¤ºæ˜¯è‡ªç”±ç”Ÿæˆçš„AIå¯¹è¯
  source_event_index: null
  type: "Dialogue"
  character_id: "AI_character_1" # æœˆè§
  content: "å—¯...è¿˜è¡Œå§ï¼Œå°±æ˜¯æ•°å­¦æœ‰ç‚¹å¤´ç–¼ã€‚ä½ å‘¢ï¼Ÿ"

# --- æ¸¸æˆåœ¨æ­¤åˆ»è¢«ä¿å­˜ ---
# åç»­çš„å¯¹è¯ï¼ˆç©å®¶çš„ç¬¬äºŒè½®è¾“å…¥å’ŒAIçš„å›å¤ï¼‰å°šæœªå‘ç”Ÿï¼Œå› æ­¤ä¸ä¼šå‡ºç°åœ¨è®°å½•ä¸­ã€‚
```

ç« èŠ‚äº‹ä»¶ä¼šè½½å…¥åˆ°å¯¹è¯è®°å½•ï¼Œä¾¿äºå‰ç«¯åˆ†ç« èŠ‚æ˜¾ç¤ºèŠå¤©è®°å½•ã€‚

å¦‚æœå‰§æœ¬è¿™æ ·å†™ï¼š

```yaml
Events:
  - "Type: Narration | Mode: Preset": |
      å¤©ç©ºæ˜¯ç°è‰²çš„ï¼Œé›¨ä¸è¿ç»µä¸ç»ã€‚
  - "Type: Player | Mode: Input": |
      ï¼ˆç©å®¶è¾“å…¥â€œè¿™æ˜¯å“ªé‡Œâ€¦â€¦â€ï¼‰
  # ç« èŠ‚äº‹ä»¶
  - "Type: Chapter | Mode: Preset":
      Title: "ç¬¬ä¸€ç« ï¼šè‹é†’"
      Number: 1
      Description: "åœ¨é™Œç”Ÿçš„æˆ¿é—´ä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ã€‚"
  - "Type: Narration | Mode: Preset": |
      ä½ ç¼“ç¼“çå¼€çœ¼ç›ï¼Œå‘ç°è‡ªå·±æ­£èººåœ¨ä¸€å¼ æŸ”è½¯çš„åºŠä¸Šã€‚
```

é‚£ä¹ˆå¯¹åº”çš„å¯¹è¯è®°å½•å‚¨å­˜æ˜¯è¿™æ ·çš„ï¼š

```yaml
# å¯¹è¯è®°å½•.yaml
# --- åºç« å†…å®¹ (åœ¨ç¬¬ä¸€ä¸ªç« èŠ‚æ ‡è®°å‰) ---
- id: "evt_001"
  timestamp: "2023-10-28T10:00:05Z"
  source_unit_id: "å‰§æƒ…_01"
  source_event_index: 0
  type: "Narration"
  content: "å¤©ç©ºæ˜¯ç°è‰²çš„ï¼Œé›¨ä¸è¿ç»µä¸ç»ã€‚"

- id: "evt_002"
  timestamp: "2023-10-28T10:00:20Z"
  source_unit_id: "å‰§æƒ…_01"
  source_event_index: 1
  type: "Player"
  content: "è¿™æ˜¯å“ªé‡Œâ€¦â€¦"

# --- ç« èŠ‚æ ‡è®°äº‹ä»¶ ---
- id: "evt_003"
  timestamp: "2023-10-28T10:00:21Z"
  source_unit_id: "å‰§æƒ…_01"
  source_event_index: 2
  type: "Chapter"  # <--- å…³é”®ç±»å‹
  # data å­—æ®µåŒ…å«äº†æ‰€æœ‰ç»“æ„åŒ–ä¿¡æ¯ï¼Œä¾›å‰ç«¯ä½¿ç”¨
  data:
    title: "ç¬¬ä¸€ç« ï¼šè‹é†’"
    number: 1
    description: "åœ¨é™Œç”Ÿçš„æˆ¿é—´ä¸­é†’æ¥ï¼Œè®°å¿†ä¸€ç‰‡ç©ºç™½ã€‚"

# --- ç¬¬ä¸€ç« å¼€å§‹åçš„å†…å®¹ ---
- id: "evt_004"
  timestamp: "2023-10-28T10:00:30Z"
  source_unit_id: "å‰§æƒ…_01"
  source_event_index: 3
  type: "Narration"
  content: "ä½ ç¼“ç¼“çå¼€çœ¼ç›ï¼Œå‘ç°è‡ªå·±æ­£èººåœ¨ä¸€å¼ æŸ”è½¯çš„åºŠä¸Šã€‚"

- id: "evt_005"
  timestamp: "2023-10-28T10:01:00Z"
  source_unit_id: "å‰§æƒ…_01"
  source_event_index: 4 # å‡è®¾è¿™æ˜¯ä¸‹ä¸€ä¸ªäº‹ä»¶
  type: "Dialogue"
  character_id: "AI_character_1"
  content: "ä½ é†’äº†ï¼Ÿæ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ"
```


è¯·æ ¹æ®è¿™ä¸ªæ¶æ„è®¾è®¡ï¼Œç¼–å†™ä¸€ä¸ªç‹¼äººæ€åº”ç”¨ã€‚
```
# logger.py
import logging
import sys
import time
import threading
from datetime import datetime
import os
import re  # Import re for ANSI stripping

# æ—¥å¿—é…ç½®
ENABLE_FILE_LOGGING = True  # æ˜¯å¦å¯ç”¨æ–‡ä»¶æ—¥å¿—è®°å½•
LOG_FILE_DIRECTORY = "run_logs"  # æ—¥å¿—æ–‡ä»¶å­˜å‚¨çš„ç›¸å¯¹ç›®å½•

# æ³¨æ„ï¼Œè‹¥ç¯å¢ƒå˜é‡DEBUG_MODE = True/falseæ—¶ï¼Œä¼šè¦†ç›–LOG_FILE_LEVELçš„è®¾ç½®
LOG_FILE_LEVEL = logging.DEBUG  # å¯ä»¥è®¾ç½®ä¸º logging.DEBUGï¼Œlogging.INFO, logging.WARNING, logging.ERROR

ANIMATION_STYLES = {
    'braille': ['â¢¿', 'â£»', 'â£½', 'â£¾', 'â£·', 'â£¯', 'â£Ÿ', 'â¡¿'],
    'spinner': ['-', '\\', '|', '/'],
    'dots': ['.  ', '.. ', '...', ' ..', '  .', '   '],
    'arrows': ['â†', 'â†–', 'â†‘', 'â†—', 'â†’', 'â†˜', 'â†“', 'â†™'],
    'moon': ['ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜'],
    'clock': ['ğŸ•›', 'ğŸ•', 'ğŸ•‘', 'ğŸ•’', 'ğŸ•“', 'ğŸ•”', 'ğŸ••', 'ğŸ•–', 'ğŸ•—', 'ğŸ•˜', 'ğŸ•™', 'ğŸ•š'],
    'directional_arrows_unicode': ['â¬†ï¸', 'â†—ï¸', 'â¡ï¸', 'â†˜ï¸', 'â¬‡ï¸', 'â†™ï¸', 'â¬…ï¸', 'â†–ï¸'],
    'traffic_lights': ['ğŸ”´', 'ğŸŸ¡', 'ğŸŸ¢'],
    'growth_emoji': ['ğŸŒ±', 'ğŸŒ¿', 'ğŸŒ³'],
    'weather_icons': ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'âš¡ï¸'],
    'heartbeat': ['â™¡', 'â™¥'],
}

_ansi_escape_regex = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')

def _strip_ansi_codes(text):
    """Removes ANSI escape codes from a string."""
    return _ansi_escape_regex.sub('', text)

sys.stderr.flush()

def wcswidth(s):
    """å›é€€ wcswidth, å°†é ASCII å­—ç¬¦è§†ä¸ºå®½åº¦2ã€‚åº”åœ¨å‰¥ç¦»ANSIç åä½¿ç”¨ã€‚"""
    if not isinstance(s, str):
        return len(s) if s else 0
    length = 0
    for char_ in s:  # Assumes s is already stripped of ANSI codes
        if ord(char_) < 128:
            length += 1
        else:
            length += 2
    return length

class TermColors:
    GREY = '\033[90m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    BLUE = '\033[94m'
    RESET = '\033[0m'
    WHITE = '\033[97m'
    CYAN = '\033[96m'
    MAGENTA = '\033[95m'
    LIGHT_BLUE = '\033[94m'  # Actually same as BLUE in this list, but kept for intent
    ORANGE = '\033[38;5;208m'

_logger = None
_animation_thread = None
_stop_animation_event = threading.Event()

_is_animating = False
_current_animation_line_width = 0
_animation_state_lock = threading.Lock()

DEFAULT_ANIMATION_STYLE_KEY = 'braille'
DEFAULT_ANIMATION_COLOR = TermColors.WHITE  # Default color for animation if not specified

class AnimationAwareStreamHandler(logging.StreamHandler):
    def emit(self, record):
        global _is_animating, _current_animation_line_width, _animation_state_lock

        if hasattr(record, 'is_animation_control') and record.is_animation_control:
            super().emit(record)
            return

        current_animation_active_locally = False
        current_width_to_clear_locally = 0

        with _animation_state_lock:
            current_animation_active_locally = _is_animating
            current_width_to_clear_locally = _current_animation_line_width

        if current_animation_active_locally and current_width_to_clear_locally > 0:
            self.acquire()
            try:
                self.flush()
                # Ensure the full line is cleared, then cursor to start
                self.stream.write("\r" + " " * current_width_to_clear_locally + "\r")
                self.stream.flush()
            finally:
                self.release()

        super().emit(record)

class ColoredFormatter(logging.Formatter):
    DATE_FORMAT = "%Y-%m-%d-%H:%M:%S"

    def __init__(self, show_timestamp=True):
        super().__init__(datefmt=self.DATE_FORMAT)
        self.show_timestamp = show_timestamp

    def format(self, record):
        if hasattr(record, 'is_animation_control') and record.is_animation_control:
            return record.getMessage()

        timestamp_part = ""
        if self.show_timestamp:
            timestamp_str = self.formatTime(record, self.DATE_FORMAT)
            timestamp_part = f"{timestamp_str} "

        message_content = record.getMessage()
        level_name = record.levelname
        level_prefix_text = f"[{level_name}]: "

        if record.levelno == logging.DEBUG:
            return f"{TermColors.GREY}{timestamp_part}{level_prefix_text}{message_content}{TermColors.RESET}"

        level_color = ""
        if record.levelno == logging.INFO:
            level_color = TermColors.GREEN
        elif record.levelno == logging.WARNING:
            level_color = TermColors.YELLOW
        elif record.levelno == logging.ERROR:
            level_color = TermColors.RED

        colored_level_prefix = f"{level_color}{level_prefix_text}{TermColors.RESET}"
        return f"{timestamp_part}{colored_level_prefix}{message_content}"


def _animate(message="Loading", animation_chars=None, color_code=DEFAULT_ANIMATION_COLOR):
    global _is_animating, _current_animation_line_width, _animation_state_lock, _stop_animation_event

    if animation_chars is None:
        animation_chars = ANIMATION_STYLES[DEFAULT_ANIMATION_STYLE_KEY]

    idx = 0
    last_char_for_clear = animation_chars[0]

    while not _stop_animation_event.is_set():
        char = animation_chars[idx % len(animation_chars)]
        last_char_for_clear = char

        full_animation_line_with_ansi = f"{color_code}{message} {char}{TermColors.RESET} "

        stripped_line_for_width = _strip_ansi_codes(full_animation_line_with_ansi)
        current_visible_width = wcswidth(stripped_line_for_width)

        with _animation_state_lock:
            _current_animation_line_width = current_visible_width

        sys.stdout.write(f"\r{full_animation_line_with_ansi}")
        sys.stdout.flush()

        idx += 1
        time.sleep(0.12)

    final_animation_line_to_clear_ansi = f"{color_code}{message} {last_char_for_clear}{TermColors.RESET} "
    stripped_final_line = _strip_ansi_codes(final_animation_line_to_clear_ansi)
    width_to_clear = wcswidth(stripped_final_line)

    sys.stdout.write("\r" + " " * width_to_clear + "\r")
    sys.stdout.flush()

    with _animation_state_lock:
        _is_animating = False
        _current_animation_line_width = 0


def start_loading_animation(message="Processing",
                            animation_style_key=DEFAULT_ANIMATION_STYLE_KEY,
                            animation_color=DEFAULT_ANIMATION_COLOR):
    global _animation_thread, _stop_animation_event, _is_animating, _current_animation_line_width, _animation_state_lock

    with _animation_state_lock:
        if _is_animating:
            log_debug("Animation already running, not starting another one.")
            return

        _stop_animation_event.clear()
        selected_chars = ANIMATION_STYLES.get(animation_style_key, ANIMATION_STYLES[DEFAULT_ANIMATION_STYLE_KEY])

        initial_char = selected_chars[0]
        initial_full_line_ansi = f"{animation_color}{message} {initial_char}{TermColors.RESET} "
        stripped_initial_line = _strip_ansi_codes(initial_full_line_ansi)
        initial_width = wcswidth(stripped_initial_line)

        _is_animating = True
        _current_animation_line_width = initial_width

        _animation_thread = threading.Thread(target=_animate,
                                             args=(message, selected_chars, animation_color),
                                             daemon=True)
        _animation_thread.start()


def stop_loading_animation(success=True, final_message=None):
    global _animation_thread, _stop_animation_event, _is_animating, _animation_state_lock

    was_animating_when_called = False
    with _animation_state_lock:
        if _is_animating or _animation_thread is not None:
            was_animating_when_called = True
            _stop_animation_event.set()

    if not was_animating_when_called:
        if final_message:
            if success:
                log_info(f"{TermColors.GREEN}âœ”{TermColors.RESET} {final_message}")
            else:
                log_error(f"{TermColors.RED}âœ–{TermColors.RESET} {final_message}")
        return

    current_thread_ref = _animation_thread
    if current_thread_ref and current_thread_ref.is_alive():
        current_thread_ref.join(timeout=2)

    with _animation_state_lock:
        _is_animating = False
        _current_animation_line_width = 0
        _animation_thread = None

    if final_message:
        if success:
            log_info(f"{TermColors.GREEN}âœ”{TermColors.RESET} {final_message}")
        else:
            log_error(f"{TermColors.RED}âœ–{TermColors.RESET} {final_message}")

def initialize_logger(app_name="AppLogger", config_debug_mode=True, show_timestamp=True):
    global _logger
    _logger = logging.getLogger(app_name)
    _logger.propagate = False

    if config_debug_mode:
        _logger.setLevel(logging.DEBUG)
    else:
        _logger.setLevel(logging.INFO)

    if _logger.hasHandlers():
        for handler in _logger.handlers[:]:
            handler.close()
            _logger.removeHandler(handler)

    console_handler = AnimationAwareStreamHandler(sys.stdout)
    console_formatter = ColoredFormatter(show_timestamp=show_timestamp)
    console_handler.setFormatter(console_formatter)
    _logger.addHandler(console_handler)

    if ENABLE_FILE_LOGGING:
        try:
            if not os.path.exists(LOG_FILE_DIRECTORY):
                os.makedirs(LOG_FILE_DIRECTORY, exist_ok=True)

            log_filename = datetime.now().strftime(f"{app_name}_%Y-%m-%d_%H-%M-%S.log")
            log_filepath = os.path.join(LOG_FILE_DIRECTORY, log_filename)

            file_handler = logging.FileHandler(log_filepath, encoding='utf-8')
            file_formatter = logging.Formatter(
                '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                datefmt=ColoredFormatter.DATE_FORMAT
            )
            file_handler.setFormatter(file_formatter)
            file_handler.setLevel(LOG_FILE_LEVEL)
            _logger.addHandler(file_handler)
        except Exception as e:
            sys.stderr.write(
                f"{TermColors.RED}é”™è¯¯: åˆå§‹åŒ–æ–‡ä»¶æ—¥å¿—è®°å½•å¤±è´¥: {e}{TermColors.RESET}\n"
            )
            sys.stderr.flush()
    return _logger

def get_logger():
    global _logger
    if _logger is None:
        sys.stderr.write(
            f"{TermColors.YELLOW}è­¦å‘Š: æ—¥å¿—è®°å½•å™¨åœ¨æ˜¾å¼åˆå§‹åŒ–ä¹‹å‰è¢«è®¿é—®ã€‚ "
            f"å°†ä½¿ç”¨é»˜è®¤å€¼è¿›è¡Œåˆå§‹åŒ–ã€‚{TermColors.RESET}\n"
        )
        sys.stderr.flush()
        _logger = initialize_logger()
    return _logger

def log_debug(message, *args, **kwargs): get_logger().debug(message, *args, **kwargs)

def log_info(message, *args, **kwargs): get_logger().info(message, *args, **kwargs)

def log_warning(message, *args, **kwargs): get_logger().warning(message, *args, **kwargs)

def log_error(message, *args, **kwargs): get_logger().error(message, *args, **kwargs)

def log_info_color(message, color_code=TermColors.GREEN, *args, **kwargs):
    get_logger().info(f"{color_code}{message}{TermColors.RESET}", *args, **kwargs)

def log_warning_color(message, color_code=TermColors.YELLOW, *args, **kwargs):
    get_logger().warning(f"{color_code}{message}{TermColors.RESET}", *args, **kwargs)

def log_error_color(message, color_code=TermColors.RED, *args, **kwargs):
    get_logger().error(f"{color_code}{message}{TermColors.RESET}", *args, **kwargs)

def log_rag_output(message, *args, **kwargs):  # Example of a domain-specific logger
    get_logger().info(f"{TermColors.BLUE}{message}{TermColors.RESET}", *args, **kwargs)

if __name__ == "__main__":
    # 1. Initialize logger - app_name will be part of the log file name
    initialize_logger(app_name="æ¼”ç¤ºåº”ç”¨", config_debug_mode=True, show_timestamp=True)
    log_info("=============== ç‚«å½©æ—¥å¿—ä¸åŠ è½½åŠ¨ç”»æ¼”ç¤ºå¼€å§‹ ===============")
    log_debug("è¿™æ˜¯ä¸€ä¸ªè°ƒè¯•æ¶ˆæ¯ï¼šæ—¥å¿—ç³»ç»Ÿå·²æˆåŠŸåˆå§‹åŒ–ã€‚")
    if not ENABLE_FILE_LOGGING:
        log_warning("æ–‡ä»¶æ—¥å¿—è®°å½•å·²ç¦ç”¨ã€‚å¦‚éœ€å¯ç”¨ï¼Œè¯·è®¾ç½® ENABLE_FILE_LOGGING = True")
    else:
        log_info(f"æ–‡ä»¶æ—¥å¿—å·²å¯ç”¨ï¼Œæ—¥å¿—å°†å­˜å‚¨åœ¨ '{LOG_FILE_DIRECTORY}' ç›®å½•ä¸‹ã€‚")

    # 2. Basic log levels demo
    log_info("æ¼”ç¤º2.1: log_infoæ˜¯ä¸€æ¡ INFO ä¿¡æ¯ã€‚")
    log_warning("æ¼”ç¤º2.2: log_warningæ˜¯ä¸€æ¡è­¦å‘Š WARNING ä¿¡æ¯ã€‚")
    log_error("æ¼”ç¤º2.3: log_erroræ˜¯ä¸€æ¡é”™è¯¯ ERROR ä¿¡æ¯ã€‚")
    log_debug("æ¼”ç¤º2.4: log_debugæ˜¯ä¸€æ¡è°ƒè¯• DEBUG ä¿¡æ¯ã€‚DEBUGä¿¡æ¯ï¼ˆåŒ…æ‹¬å¯¹åº”æ—¶é—´æˆ³ï¼‰å…¨éƒ¨ä¿æŒç°è‰²")

    log_info_color("æ¼”ç¤º2.5: log_info_colorçš„ INFO ä¿¡æ¯é»˜è®¤å¸¦æœ‰é†’ç›®çš„ç»¿è‰²ã€‚")
    log_info_color("å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰log_info_colorçš„é¢œè‰²", TermColors.MAGENTA)
    log_warning_color("æ¼”ç¤º2.6: log_warning_colorçš„ WARNING ä¿¡æ¯é»˜è®¤å¸¦æœ‰é†’ç›®çš„é»„è‰²ã€‚")
    log_warning_color("å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ”¹æˆè“çš„", TermColors.BLUE)
    log_error_color("æ¼”ç¤º2.7: log_error_colorçš„ ERROR ä¿¡æ¯é»˜è®¤å¸¦æœ‰é†’ç›®çš„çº¢è‰²ã€‚")
    log_error_color("ä¸€ä¸ªç»¿è‰²çš„ERROR?", TermColors.GREEN)

    # 3. Loading animation demo
    log_info("æ¼”ç¤º3.1: é»˜è®¤åŠ è½½åŠ¨ç”» (brailleæ ·å¼, é»˜è®¤ç™½è‰²)")
    # Pass message without internal colors, use animation_color for the whole line
    start_loading_animation(message="ä»»åŠ¡Aå¤„ç†ä¸­")
    time.sleep(2)
    stop_loading_animation(success=True, final_message="ä»»åŠ¡AæˆåŠŸå®Œæˆ!")

    log_info("æ¼”ç¤º3.2: è‡ªå®šä¹‰åŠ¨ç”»æ ·å¼ (spinneræ ·å¼, é»˜è®¤ç™½è‰²)")
    start_loading_animation(message="ä»»åŠ¡Bæ‰§è¡Œä¸­", animation_style_key='spinner')
    time.sleep(2)
    stop_loading_animation(success=True, final_message="ä»»åŠ¡B (spinner) æ‰§è¡Œå®Œæ¯•!")

    log_info("æ¼”ç¤º3.3: è‡ªå®šä¹‰åŠ¨ç”»é¢œè‰² (é»˜è®¤brailleæ ·å¼, é’è‰²)")
    start_loading_animation(message="ä»»åŠ¡CåŠ è½½ä¸­", animation_color=TermColors.CYAN)
    time.sleep(2)
    stop_loading_animation(success=True, final_message="ä»»åŠ¡C (é’è‰²) åŠ è½½å®Œæˆ!")

    log_info("æ¼”ç¤º3.4: ä¼ é€’æœ¬èº«å¸¦é¢œè‰²çš„æ¶ˆæ¯ç»™åŠ¨ç”»")
    # This shows that message can carry its own colors, and animation_color is an outer wrapper
    # animation_color (default WHITE) wraps (MAGENTA "Task D" RESET) + char + RESET
    start_loading_animation(
        message=f"{TermColors.MAGENTA}ä»»åŠ¡D(æœ¬èº«å“çº¢){TermColors.RESET}è¿›è¡Œä¸­",
        animation_style_key='arrows',
        animation_color=TermColors.YELLOW  # Yellow wrapper
    )
    time.sleep(2.5)
    stop_loading_animation(success=True, final_message="ä»»åŠ¡D (å“çº¢å†…å®¹ï¼Œé»„è‰²åŒ…è£…) å®Œæˆ!")

    log_info("æ¼”ç¤º3.5: å…¶ä»–åŠ¨ç”»æ ·å¼ (moonæ ·å¼, æµ…è“è‰²)")
    start_loading_animation(message="æœˆç›¸è§‚å¯Ÿ", animation_style_key='moon', animation_color=TermColors.LIGHT_BLUE)
    time.sleep(2.5)
    stop_loading_animation(success=True, final_message="æœˆç›¸è§‚å¯Ÿå®Œæ¯•!")

    log_info("æ¼”ç¤º3.6: åŠ¨ç”»æœŸé—´è¿›è¡Œæ—¥å¿—è®°å½• (dotsæ ·å¼, æ©™è‰²)")
    start_loading_animation(message="æ©™è‰²ç‚¹ç‚¹ä»»åŠ¡", animation_style_key='dots', animation_color=TermColors.ORANGE)
    log_info("åŠ¨ç”»å·²å¯åŠ¨ï¼Œç°åœ¨è®°å½•ä¸€æ¡ INFO æ¶ˆæ¯ï¼ŒåŠ¨ç”»ä¼šè‡ªåŠ¨é¿è®©ã€‚")
    time.sleep(1)
    log_warning("è¿™æ˜¯ä¸€æ¡è­¦å‘Š WARNING æ¶ˆæ¯ï¼ŒåŠ¨ç”»ä»åœ¨åå°ç»§ç»­ã€‚")
    time.sleep(1)
    log_debug("ä¸€æ¡è°ƒè¯• DEBUG æ¶ˆæ¯ï¼ŒåŠ¨ç”»å³å°†åœæ­¢å¹¶æ¨¡æ‹Ÿå¤±è´¥ã€‚")
    time.sleep(1)
    stop_loading_animation(success=False, final_message="æ©™è‰²ç‚¹ç‚¹ä»»åŠ¡æ¨¡æ‹Ÿå¤±è´¥ã€‚")

    log_info("æ¼”ç¤º3.7: åœæ­¢åŠ¨ç”»æ—¶ä¸æ˜¾ç¤ºæœ€ç»ˆæ¶ˆæ¯")
    start_loading_animation(message="çŸ­æš‚å¤„ç†")
    time.sleep(1.5)
    stop_loading_animation()  # No final_message
    log_info("åŠ¨ç”»å·²åœæ­¢ï¼Œä¸æä¾› final_messageã€‚")

    # 4. Special color log functions
    log_info("æ¼”ç¤º4.1: ä½¿ç”¨ log_info_color è¾“å‡ºè‡ªå®šä¹‰é¢œè‰² INFO (ä¾‹å¦‚ç´«çº¢è‰²)")
    log_info_color("è¿™æ˜¯ä¸€æ¡ç´«çº¢è‰²çš„ INFO ä¿¡æ¯ã€‚", TermColors.MAGENTA)

    log_info("æ¼”ç¤º4.2: ä½¿ç”¨ log_rag_output è¾“å‡ºç‰¹å®šæ ¼å¼ INFO")
    log_rag_output("è¿™æ˜¯ä¸€ä¸ªRAG æ¨¡å‹è¾“å‡ºå†…å®¹ (è“è‰²)")

    # 5. Re-initialize logger: turn off console timestamp
    log_info("æ¼”ç¤º5: é‡æ–°åˆå§‹åŒ–æ—¥å¿—ï¼Œå…³é—­æ§åˆ¶å°æ—¶é—´æˆ³ (æ–‡ä»¶æ—¥å¿—ä¸å—å½±å“)")
    initialize_logger(app_name="æ¼”ç¤ºåº”ç”¨-æ— æ—¶é—´æˆ³", config_debug_mode=True, show_timestamp=False)
    log_info("è¿™æ¡ INFO ä¿¡æ¯åœ¨æ§åˆ¶å°ä¸æ˜¾ç¤ºæ—¶é—´æˆ³ã€‚")
    log_debug("è¿™æ¡ DEBUG ä¿¡æ¯åœ¨æ§åˆ¶å°ä¹Ÿä¸æ˜¾ç¤ºæ—¶é—´æˆ³ã€‚")
    start_loading_animation(message="æ— æ—¶é—´æˆ³ä»»åŠ¡æ‰§è¡Œ")
    time.sleep(1.5)
    stop_loading_animation(final_message="æ— æ—¶é—´æˆ³ä»»åŠ¡å®Œæˆã€‚")

    # 6. Restore timestamp and test print() interaction
    log_info("æ¼”ç¤º6: æ¢å¤æ—¶é—´æˆ³å¹¶æµ‹è¯•åŠ¨ç”»ä¸æ™®é€š print() è¯­å¥çš„äº¤äº’")
    initialize_logger(app_name="æ¼”ç¤ºåº”ç”¨", config_debug_mode=True, show_timestamp=True)  # Restore default
    log_info("æ—¥å¿—æ—¶é—´æˆ³å·²æ¢å¤ã€‚")

    print(f"{TermColors.YELLOW}è¿™æ˜¯ä¸€æ¡æ™®é€šçš„ print() è¯­å¥ï¼Œåœ¨åŠ¨ç”»å¼€å§‹å‰ã€‚{TermColors.RESET}")
    start_loading_animation(message="æµ‹è¯•ä¸printäº¤äº’")
    time.sleep(1)
    # Standard print() is not intercepted by the logger's handler.
    # It will likely mess up the animation line.
    print(f"{TermColors.RED}è­¦å‘Š: ä¸‹é¢è¿™æ¡ print() è¯­å¥ä¼šæ‰“æ–­å½“å‰åŠ¨ç”»è¡Œã€‚{TermColors.RESET}")
    time.sleep(1)
    log_info("è¿™æ¡æ—¥å¿—æ¶ˆæ¯åœ¨ print() ä¹‹åï¼Œä¼šç”± AnimationAwareStreamHandler æ­£ç¡®å¤„ç†ã€‚")
    time.sleep(1)
    stop_loading_animation(final_message="åŠ¨ç”»ä¸ print() äº¤äº’æµ‹è¯•ç»“æŸã€‚")
    print(f"{TermColors.GREEN}åŠ¨ç”»ç»“æŸåçš„å¦ä¸€æ¡ print() è¯­å¥ã€‚{TermColors.RESET}")

    # 7. End
    if ENABLE_FILE_LOGGING:
        log_info(f"æ‰€æœ‰æ¼”ç¤ºå·²å®Œæˆã€‚è¯·æ£€æŸ¥ '{LOG_FILE_DIRECTORY}' ç›®å½•ä¸­çš„æ—¥å¿—æ–‡ä»¶ã€‚")
    else:
        log_info("æ‰€æœ‰æ¼”ç¤ºå·²å®Œæˆã€‚æ–‡ä»¶æ—¥å¿—è®°å½•å½“å‰å·²ç¦ç”¨ã€‚")
    log_info("=============== æ¼”ç¤ºç»“æŸ ===============")
```
ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªlogå®šä¹‰ã€‚
```
import sys
import config
from logger import (
    initialize_logger,
    start_loading_animation,
    stop_loading_animation,
    TermColors,
    log_debug,
    log_info,
    log_warning,
    log_error,
    log_info_color,
    log_warning_color,
    log_error_color
)
# æ—©æœŸæ—¥å¿—åˆå§‹åŒ–ï¼Œç”¨äºåœ¨pythonåº“å¯¼å…¥æœŸé—´æ˜¾ç¤ºåŠ¨ç”»
_early_init_app_name = getattr(config, 'AI_NAME', "App") + "_PreLoad"
initialize_logger(
    config_debug_mode=getattr(config, 'DEBUG_MODE', False),
    app_name=_early_init_app_name,
    show_timestamp=False  # æ—©æœŸåŠ è½½ä¿¡æ¯å¯ä»¥ç®€æ´äº›
)
log_debug("æ‚¨ç›®å‰å¤„äºå¼€å‘è€…æ¨¡å¼ä¸­ï¼Œç»ˆç«¯å°†ä¼šæ˜¾ç¤ºå¤§é‡çš„ç°è‰²DEBUGæ—¥å¿—ï¼Œè‹¥è¦è·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒï¼Œå…³é—­å¼€å‘è€…æ¨¡å¼")
log_debug("æ­£åœ¨åŠ è½½Pythonä¾èµ–åº“ï¼Œæ­¤è¿‡ç¨‹å¯èƒ½è¾ƒæ…¢ã€‚")
start_loading_animation(
    message=f"{TermColors.CYAN}{config.AI_NAME}æ­£åœ¨è¯•å›¾èµ·åºŠ{TermColors.RESET}",
    animation_style_key='dots'
)

# å¼€å§‹å¯¼å…¥å¯èƒ½è€—æ—¶çš„æ¨¡å—
import requests
import json
import os
from datetime import datetime, timezone
import uuid
import torch
import re

_sentence_transformer_imported_ok = True
_chromadb_imported_ok = True

try:
    from sentence_transformers import SentenceTransformer
except ImportError:
    _sentence_transformer_imported_ok = False
    if hasattr(config, 'USE_RAG') and config.USE_RAG:
        sys.stderr.write(
            f"{TermColors.RED}é”™è¯¯: 'sentence-transformers' æ¨¡å—æœªæ‰¾åˆ°ï¼Œä½† RAG åŠŸèƒ½å·²å¯ç”¨ã€‚\n"
            f"è¯·å®‰è£…: pip install sentence-transformers{TermColors.RESET}\n")
        sys.stderr.flush()


    class SentenceTransformer:
        def __init__(self, *args, **kwargs): pass

        def encode(self, *args, **kwargs): raise NotImplementedError("SentenceTransformer is not available.")

try:
    import chromadb
except ImportError:
    _chromadb_imported_ok = False
    if hasattr(config, 'USE_RAG') and config.USE_RAG:
        sys.stderr.write(
            f"{TermColors.RED}é”™è¯¯: 'chromadb' æ¨¡å—æœªæ‰¾åˆ°ï¼Œä½† RAG åŠŸèƒ½å·²å¯ç”¨ã€‚\n"
            f"è¯·å®‰è£…: pip install chromadb{TermColors.RESET}\n")
        sys.stderr.flush()

    class chromadb:
        class PersistentClient:
            def __init__(self, *args, **kwargs): pass

            def get_or_create_collection(self, *args, **kwargs): raise NotImplementedError(
                "chromadb is not available.")

        def get_collection(self, *args, **kwargs): raise NotImplementedError(
            "chromadb is not available.")

_early_load_successful = True
_early_load_message = "æ ¸å¿ƒæ¨¡å—åŠ è½½å®Œæˆã€‚"

if hasattr(config, 'USE_RAG') and config.USE_RAG:
    if not _sentence_transformer_imported_ok or not _chromadb_imported_ok:
        _early_load_successful = False
        missing_modules = []
        if not _sentence_transformer_imported_ok: missing_modules.append("'sentence-transformers'")
        if not _chromadb_imported_ok: missing_modules.append("'chromadb'")
        _early_load_message = f"æ ¸å¿ƒRAGæ¨¡å— ({', '.join(missing_modules)}) åŠ è½½å¤±è´¥ã€‚RAGåŠŸèƒ½å¯èƒ½å—é™ã€‚"

stop_loading_animation(success=_early_load_successful)

# --- å†å²è®°å½•ç®¡ç† ---
def get_history_filepath():
    now = datetime.now()
    year_month_path = os.path.join(config.HISTORY_BASE_PATH, now.strftime("%Yå¹´%mæœˆ"))
    day_path = os.path.join(year_month_path, now.strftime("%dæ—¥"))
    os.makedirs(day_path, exist_ok=True)
    session_start_time_str = now.strftime("%Y%m%d_%H%M%S")
    return os.path.join(day_path, f"session_{session_start_time_str}.json")

def save_session_history(session_messages, filepath):
    try:
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(session_messages, f, ensure_ascii=False, indent=4)
        log_debug(f"ä¼šè¯å†å²å·²ä¿å­˜åˆ°: {filepath}")
    except IOError as e:
        log_error_color(f"ä¿å­˜å†å²è®°å½•å¤±è´¥: {e}")
        log_debug(f"IOError saving history: {e}", exc_info=True)

def parse_session_time_from_filename(filename):
    match = re.search(r"session_(\d{8}_\d{6})\.json", filename)
    if match:
        try:
            dt_obj = datetime.strptime(match.group(1), "%Y%m%d_%H%M%S")
            return dt_obj.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M")
        except ValueError:
            log_debug(f"æ— æ³•ä»æ–‡ä»¶å {filename} è§£ææœ‰æ•ˆæ—¥æœŸæ—¶é—´ã€‚")
            return "æœªçŸ¥æ—¶é—´"
    return "æœªçŸ¥æ—¶é—´"

def load_all_historical_data():
    all_messages_flat = []
    historical_sessions_map = {}

    if not os.path.exists(config.HISTORY_BASE_PATH):
        log_warning(f"å†å²è®°å½•åŸºç¡€è·¯å¾„ {config.HISTORY_BASE_PATH} ä¸å­˜åœ¨ã€‚æœªåŠ è½½ä»»ä½•å†å²ã€‚")
        return all_messages_flat, historical_sessions_map

    log_debug(f"å¼€å§‹ä» {config.HISTORY_BASE_PATH} åŠ è½½å†å²å¯¹è¯æ•°æ®...")
    loaded_files_count = 0
    total_messages_loaded = 0
    for root, _, files in os.walk(config.HISTORY_BASE_PATH):
        sorted_files = sorted([f for f in files if f.endswith(".json")])
        for filename in sorted_files:
            filepath = os.path.join(root, filename)
            session_time_str = parse_session_time_from_filename(filename)
            try:
                with open(filepath, 'r', encoding='utf-8') as f:
                    session_data = json.load(f)
                    if isinstance(session_data, list) and session_data:
                        historical_sessions_map[filename] = []
                        for idx, msg in enumerate(session_data):
                            msg_copy_flat = msg.copy()
                            msg_copy_flat['_source_file'] = filename
                            msg_copy_flat['_original_idx'] = idx
                            msg_copy_flat['_session_timestamp_str'] = session_time_str
                            all_messages_flat.append(msg_copy_flat)

                            msg_copy_map = msg.copy()
                            msg_copy_map['_source_file'] = filename
                            msg_copy_map['_original_idx'] = idx
                            msg_copy_map['_session_timestamp_str'] = session_time_str
                            historical_sessions_map[filename].append(msg_copy_map)
                        loaded_files_count += 1
                        total_messages_loaded += len(session_data)
            except (json.JSONDecodeError, IOError) as e:
                log_warning_color(f"åŠ è½½å†å²æ–‡ä»¶ {filepath} å¤±è´¥: {e}")
                log_debug(f"Failed to load history file {filepath}: {e}", exc_info=True)

    if loaded_files_count > 0:
        log_debug(f"æˆåŠŸä» {loaded_files_count} ä¸ªæ–‡ä»¶ä¸­åŠ è½½äº† {total_messages_loaded} æ¡å†å²æ¶ˆæ¯ã€‚")
    else:
        log_warning_color("æœªæ‰¾åˆ°æˆ–åŠ è½½ä»»ä½•æœ‰æ•ˆçš„å†å²ä¼šè¯æ–‡ä»¶ã€‚è¯·æ£€æŸ¥Dialogue_history/æ–‡ä»¶æ˜¯å¦æ­£ç¡®å­˜æ”¾ï¼Œè‹¥æ‚¨æ˜¯åˆæ¬¡ä½¿ç”¨æœ¬é¡¹ç›®ï¼Œè¯·å¿½ç•¥æ­¤è­¦æŠ¥")
    log_debug(f"å…±æ˜ å°„ {len(historical_sessions_map)} ä¸ªä¼šè¯ã€‚")
    return all_messages_flat, historical_sessions_map

# --- RAG ç›¸å…³ ---
embedding_model = None
chroma_client = None
chroma_collection = None
CHROMA_COLLECTION_NAME = "chat_history_collection_v4"
EMBEDDING_MODEL_NAME = 'all-MiniLM-L6-v2'

def initialize_rag_components():
    global embedding_model, chroma_client, chroma_collection, _sentence_transformer_imported_ok, _chromadb_imported_ok
    if not config.USE_RAG:
        log_info("RAGåŠŸèƒ½å·²ç¦ç”¨ (æ ¹æ®é…ç½®)ã€‚")
        return False

    if not _sentence_transformer_imported_ok:
        log_error_color("RAGç»„ä»¶åˆå§‹åŒ–å¤±è´¥: SentenceTransformer æ¨¡å—æœªèƒ½æˆåŠŸå¯¼å…¥ã€‚")
        return False
    if not _chromadb_imported_ok:
        log_error_color("RAGç»„ä»¶åˆå§‹åŒ–å¤±è´¥: ChromaDB æ¨¡å—æœªèƒ½æˆåŠŸå¯¼å…¥ã€‚")
        return False

    log_debug("å¼€å§‹åˆå§‹åŒ–RAGç»„ä»¶...")
    try:
        log_debug(f"RAG: åˆå§‹åŒ–Sentence Transformeræ¨¡å‹: {EMBEDDING_MODEL_NAME}")
        device = 'cuda' if torch.cuda.is_available() else 'cpu'
        embedding_model = SentenceTransformer(EMBEDDING_MODEL_NAME, device=device)
        log_debug(f"RAG: Sentence Transformeræ¨¡å‹ ({EMBEDDING_MODEL_NAME}) åŠ è½½æˆåŠŸ ã€‚å½“å‰ä½¿ç”¨ {device})è¿›è¡ŒRAGå‘é‡åº“åŒ¹é…çš„æ¨ç†ã€‚")

        chroma_db_path = getattr(config, 'CHROMA_DB_PATH', './chroma_db_store_v2')
        log_debug(f"RAG: åˆå§‹åŒ–ChromaDBå®¢æˆ·ç«¯ (è®°å¿†åº“å°†å­˜å‚¨åœ¨ '{chroma_db_path}').")
        chroma_client = chromadb.PersistentClient(path=chroma_db_path)
        log_debug(f"RAG: ChromaDBå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ (æ•°æ®è·¯å¾„: {chroma_db_path})ã€‚")

        log_debug(f"RAG: è·å–æˆ–åˆ›å»ºChromaDBé›†åˆ: {CHROMA_COLLECTION_NAME}")
        chroma_collection = chroma_client.get_or_create_collection(
            name=CHROMA_COLLECTION_NAME,
            metadata={"hnsw:space": "cosine"}
        )
        log_debug(
            f"RAG: ChromaDBé›†åˆ '{CHROMA_COLLECTION_NAME}' å·²å°±ç»ªã€‚å½“å‰åŒ…å« {chroma_collection.count()} æ¡ç›®ã€‚")
        return True
    except Exception as e:
        log_error_color(f"RAGç»„ä»¶åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        log_debug(f"RAG Initialization Error during component setup: {e}", exc_info=True)
        embedding_model = None
        chroma_client = None
        chroma_collection = None
        return False


def add_messages_to_rag_index(messages_with_metadata):
    global embedding_model, chroma_collection
    if not config.USE_RAG or not embedding_model or not chroma_collection:
        log_debug("RAG: ç»„ä»¶æœªåˆå§‹åŒ–æˆ–RAGå·²ç¦ç”¨ï¼Œè·³è¿‡ç´¢å¼•ã€‚")
        return

    if not messages_with_metadata:
        log_info("RAG: æ— æ¶ˆæ¯å¯ä¾›ç´¢å¼•ã€‚")
        return

    log_debug(f"RAG: å‡†å¤‡ä¸º {len(messages_with_metadata)} æ¡æ¶ˆæ¯å»ºç«‹ç´¢å¼•...")
    documents, metadatas, ids = [], [], []

    for msg in messages_with_metadata:
        content, role = msg.get('content'), msg.get('role')
        source_file, original_idx = msg.get('_source_file'), msg.get('_original_idx')

        if not all([content, isinstance(content, str), role, source_file is not None, original_idx is not None]):
            log_debug(f"RAG: è·³è¿‡æ— æ•ˆæ¶ˆæ¯è¿›è¡Œç´¢å¼• (å­—æ®µç¼ºå¤±): {str(msg)[:100]}...")
            continue

        message_id_str = f"{source_file}_{original_idx}_{role}_{content[:100]}"
        message_id = str(uuid.uuid5(uuid.NAMESPACE_DNS, message_id_str))
        documents.append(content)
        metadatas.append({"role": role, "source_file": source_file, "original_idx": original_idx})
        ids.append(message_id)

    if not documents:
        log_warning_color("RAG: ç­›é€‰åæ— æœ‰æ•ˆæ–‡æ¡£å¯ä¾›ç´¢å¼•ã€‚")
        return

    log_debug(f"RAG: æ­£åœ¨ä¸º {len(documents)} ä¸ªæ–‡æ¡£ç”ŸæˆåµŒå…¥å‘é‡...")
    embeddings = embedding_model.encode(documents).tolist()
    log_debug(f"RAG: åµŒå…¥å‘é‡ç”Ÿæˆå®Œæ¯•ã€‚Shape: ({len(embeddings)}, {len(embeddings[0]) if embeddings else 0})")

    try:
        batch_size = 500
        for i in range(0, len(ids), batch_size):
            batch_ids, batch_embeddings = ids[i:i + batch_size], embeddings[i:i + batch_size]
            batch_documents, batch_metadatas = documents[i:i + batch_size], metadatas[i:i + batch_size]
            chroma_collection.upsert(ids=batch_ids, embeddings=batch_embeddings, documents=batch_documents,
                                     metadatas=batch_metadatas)
            log_debug(f"RAG: Upserted batch {i // batch_size + 1} ({len(batch_ids)} documents).")
        log_debug(f"RAG: æˆåŠŸå‘ChromaDBä¸­æ·»åŠ /æ›´æ–°äº† {len(ids)} ä¸ªæ–‡æ¡£ã€‚")
        log_debug(f"RAG: ç´¢å¼•åº“ '{CHROMA_COLLECTION_NAME}' å½“å‰æ€»æ¡ç›®: {chroma_collection.count()}")
    except Exception as e:
        log_error_color(f"RAG: å‘ChromaDBä¸­Upsertæ–‡æ¡£æ—¶å‡ºé”™: {e}")
        log_debug(f"ChromaDB Upsert Error: {e}", exc_info=True)


def get_rag_messages_chroma(query_text, historical_sessions_map):
    global embedding_model, chroma_collection
    if not config.USE_RAG or not embedding_model or not chroma_collection:
        log_warning_color("RAG: ç»„ä»¶æœªåˆå§‹åŒ–æˆ–RAGå·²ç¦ç”¨ï¼Œè·³è¿‡æ£€ç´¢ã€‚")
        return []
    if not query_text:
        log_warning_color("RAG: æŸ¥è¯¢æ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡RAGæ£€ç´¢ã€‚")
        return []
    if chroma_collection.count() == 0:
        log_warning_color("RAG: ChromaDBé›†åˆä¸ºç©ºï¼Œè·³è¿‡RAGæ£€ç´¢ã€‚")
        return []

    num_candidates_to_fetch = config.RAG_RETRIEVAL_COUNT * config.RAG_CANDIDATE_MULTIPLIER
    num_candidates_to_fetch = min(num_candidates_to_fetch, chroma_collection.count())

    log_info_color(f"RAG: æ­£åœ¨ä¸ºæŸ¥è¯¢ \"{query_text[:50]}...\" æ£€ç´¢æœ€å¤š {num_candidates_to_fetch} ä¸ªå€™é€‰ç‰‡æ®µ...",
                   TermColors.BLUE)
    query_embedding = embedding_model.encode([query_text], show_progress_bar=False)[0].tolist()

    try:
        results = chroma_collection.query(
            query_embeddings=[query_embedding],
            n_results=num_candidates_to_fetch,
            include=["documents", "metadatas", "distances"]
        )
    except Exception as e:
        log_error_color(f"RAG æŸ¥è¯¢ChromaDBå¤±è´¥: {e}")
        log_debug(f"ChromaDB Query Error: {e}", exc_info=True)
        return []

    final_rag_messages, used_chroma_doc_ids, added_message_contents_to_llm = [], set(), set()
    retrieved_blocks_count = 0

    if results and results.get('ids') and results['ids'][0]:
        log_debug(f"RAG: ChromaDBè¿”å› {len(results['ids'][0])} ä¸ªå€™é€‰ç»“æœã€‚")
        for i in range(len(results['ids'][0])):
            if retrieved_blocks_count >= config.RAG_RETRIEVAL_COUNT:
                log_debug(f"RAG: å·²è¾¾åˆ°æœŸæœ›çš„ {config.RAG_RETRIEVAL_COUNT} ä¸ªç‹¬ç«‹ä¸Šä¸‹æ–‡å—ã€‚åœæ­¢å¤„ç†å€™é€‰ã€‚")
                break
            try:
                core_doc_id, core_doc_content = results['ids'][0][i], results['documents'][0][i]
                metadata, distance = results['metadatas'][0][i], results['distances'][0][i]
            except (IndexError, TypeError, KeyError) as e:
                log_warning(f"RAG: ChromaDBç»“æœç´¢å¼• {i} å¤„æ•°æ®ä¸å®Œæ•´æˆ–æ ¼å¼é”™è¯¯ã€‚è·³è¿‡ã€‚è¯¦ç»†: {e}")
                continue

            if core_doc_id in used_chroma_doc_ids or core_doc_content == query_text:
                log_debug(f"RAG: è·³è¿‡å·²ä½¿ç”¨æˆ–ä¸æŸ¥è¯¢ç›¸åŒçš„æ–‡æ¡£ ID {core_doc_id}.")
                continue

            source_file, original_idx = metadata.get("source_file"), metadata.get("original_idx")
            if source_file not in historical_sessions_map or not isinstance(original_idx, int):
                log_warning(f"RAG: æ–‡æ¡£ {core_doc_id} å…ƒæ•°æ®ä¸å®Œæ•´æˆ–ä¼šè¯æœªåœ¨Mapä¸­æ‰¾åˆ°ã€‚è·³è¿‡ã€‚")
                continue

            current_session_messages = historical_sessions_map[source_file]
            if not (0 <= original_idx < len(current_session_messages)):
                log_warning(f"RAG: åŸå§‹ç´¢å¼• {original_idx} è¶…å‡º '{source_file}' ä¼šè¯è¾¹ç•Œã€‚è·³è¿‡ã€‚")
                continue

            start_idx = max(0, original_idx - config.RAG_CONTEXT_M_BEFORE)
            end_idx = min(len(current_session_messages), original_idx + config.RAG_CONTEXT_N_AFTER + 1)

            context_block_for_llm, context_block_display_info, potential_block_messages = [], [], []
            for j in range(start_idx, end_idx):
                msg_obj = current_session_messages[j]
                msg_content, msg_role = msg_obj.get("content"), msg_obj.get("role", "unknown")
                session_time_str = msg_obj.get("_session_timestamp_str", "æœªçŸ¥æ—¶é—´")

                if msg_content and msg_content not in added_message_contents_to_llm:
                    contextualized_content = f"[å†å²å¯¹è¯ç‰‡æ®µ - {session_time_str}] {msg_content}"
                    potential_block_messages.append({"role": msg_role, "content": contextualized_content})
                    is_core = " (æ ¸å¿ƒæ£€ç´¢)" if j == original_idx else ""
                    context_block_display_info.append(
                        f"  - ({session_time_str}) [{msg_role}]{is_core}: \"{msg_content[:50]}...\"")

            if potential_block_messages:
                context_block_for_llm.extend(potential_block_messages)
                for msg in potential_block_messages: added_message_contents_to_llm.add(msg['content'])
                used_chroma_doc_ids.add(core_doc_id)
                retrieved_blocks_count += 1
                final_rag_messages.extend(context_block_for_llm)
                log_info_color(
                    f"\nRAG ç³»ç»Ÿæ£€ç´¢åˆ°å†å²å¯¹è¯ç‰‡æ®µ (æ ¸å¿ƒè·ç¦»: {distance:.4f}, æº: {source_file}, æ ¸å¿ƒç´¢å¼•: {original_idx}):",
                    # MODIFIED
                    TermColors.MAGENTA)
                for line in context_block_display_info:
                    log_info_color(f"\n{line}", TermColors.MAGENTA)  # MODIFIED
                log_debug(f"RAG: æ·»åŠ ä¸Šä¸‹æ–‡å— (ID {core_doc_id}). LLMçš„RAGæ¶ˆæ¯æ€»æ•°: {len(final_rag_messages)}")
            else:
                log_debug(f"RAG: æ ¸å¿ƒæ–‡æ¡£ID {core_doc_id} çš„ä¸Šä¸‹æ–‡å—ä¸ºç©ºæˆ–æ‰€æœ‰æ¶ˆæ¯å·²å»é‡ã€‚")

    if not final_rag_messages:
        log_info_color("RAG ç³»ç»Ÿ: æœªåœ¨å†å²è®°å½•ä¸­æ‰¾åˆ°ä¸å½“å‰é—®é¢˜ç›¸å…³çš„ã€éé‡å¤çš„æ¶ˆæ¯ã€‚", TermColors.YELLOW)
    else:
        log_info_color(
            f"RAG: ä¸ºLLMå‡†å¤‡äº† {len(final_rag_messages)} æ¡æ¶ˆæ¯ï¼Œæ¥è‡ª {retrieved_blocks_count} ä¸ªä¸åŒçš„RAGä¸Šä¸‹æ–‡å—ã€‚",
            TermColors.GREEN)
    return final_rag_messages

# --- DeepSeek API è°ƒç”¨ ---
def chat_with_deepseek(messages_payload):
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {config.API_KEY}"}
    payload = {
        "model": config.MODEL_NAME, "messages": messages_payload, "stream": True,
        "max_tokens": config.MAX_TOKENS, "temperature": config.TEMPERATURE
    }

    if config.DEBUG_MODE:
        log_debug("--- å‘é€ç»™ DeepSeek API çš„ Payload (å†…å®¹å·²æˆªæ–­) ---")
        debug_payload_display = json.loads(json.dumps(payload))
        for msg in debug_payload_display.get("messages", []):
            if 'content' in msg and isinstance(msg['content'], str):
                msg['content'] = msg['content'][:150] + ("..." if len(msg['content']) > 150 else "")
        formatted_payload_str = json.dumps(debug_payload_display, ensure_ascii=False, indent=2)
        for line in formatted_payload_str.splitlines(): log_debug(line)
        log_debug("--- Payload ç»“æŸ ---")

    assistant_full_response = ""
    api_call_succeeded = False
    animation_stopped_internally = False

    try:
        log_info_color(f"{config.AI_NAME}æ­£åœ¨è¿æ¥DeepSeek ({config.MODEL_NAME})... è¯·ç¨å€™ã€‚", TermColors.BLUE)
        start_loading_animation(
            message=f"{TermColors.LIGHT_BLUE}{config.AI_NAME}æ­£åœ¨å‘å‘†{TermColors.RESET}",
            animation_style_key='moon',
            animation_color=TermColors.LIGHT_BLUE
        )

        response = requests.post(config.API_URL, headers=headers, json=payload, stream=True,
                                 timeout=config.API_TIMEOUT_SECONDS)
        response.raise_for_status()

        first_chunk_received = False
        for chunk in response.iter_lines():
            if chunk:
                decoded_line = chunk.decode('utf-8')
                if decoded_line.startswith("data: "):
                    json_data_str = decoded_line[len("data: "):]
                    if json_data_str.strip() == "[DONE]":
                        log_debug("API Stream: [DONE] æ ‡è®°å·²æ”¶åˆ°ã€‚")
                        break
                    try:
                        data = json.loads(json_data_str)
                        content_piece = data.get("choices", [{}])[0].get("delta", {}).get("content", "")
                        if content_piece:
                            if not first_chunk_received:
                                stop_loading_animation(success=True)
                                animation_stopped_internally = True
                                print(f"{TermColors.CYAN}{config.AI_NAME}: {TermColors.RESET}", end="", flush=True)
                                first_chunk_received = True
                            sys.stdout.write(f"{TermColors.CYAN}{content_piece}{TermColors.RESET}")
                            sys.stdout.flush()
                            assistant_full_response += content_piece
                    except (json.JSONDecodeError, IndexError):
                        log_warning(f"API Stream: è§£ç æˆ–ç´¢å¼•é”™è¯¯ï¼Œæ•°æ®å—: {json_data_str}")

        if first_chunk_received:
            print();
            api_call_succeeded = True
        elif response.ok:
            log_info("API å“åº”æµç»“æŸï¼Œä½†æœªè¿”å›ä»»ä½•æ–‡æœ¬å†…å®¹ã€‚");
            api_call_succeeded = True

    except requests.exceptions.HTTPError as e_http:
        log_error_color(f"\nAPIè¯·æ±‚HTTPé”™è¯¯: {e_http} - {e_http.response.status_code} {e_http.response.reason}")
        try:
            log_error_color(f"é”™è¯¯è¯¦æƒ…: {json.dumps(e_http.response.json(), ensure_ascii=False, indent=2)}")
        except ValueError:
            log_error_color(f"é”™è¯¯å“åº”ä½“ (éJSON): {e_http.response.text}")
        log_debug(f"API HTTPError: {e_http}", exc_info=True)
    except requests.exceptions.Timeout:
        log_error_color(f"\nAPIè¯·æ±‚è¶…æ—¶ (è¶…è¿‡ {config.API_TIMEOUT_SECONDS} ç§’)ã€‚")
        log_debug("API Request Timeout", exc_info=True)
    except requests.exceptions.RequestException as e_req:
        log_error_color(f"\nAPIè¯·æ±‚å¤±è´¥: {e_req}")
        log_debug(f"API Request Exception: {e_req}", exc_info=True)
    except Exception as e_unknown:
        log_error_color(f"\nå¤„ç†APIå“åº”æ—¶å‘ç”ŸæœªçŸ¥é”™è¯¯: {e_unknown}")
        log_debug(f"Unknown error during API response processing: {e_unknown}", exc_info=True)
    finally:
        if not animation_stopped_internally:
            final_msg = None
            if not api_call_succeeded:
                final_msg = "ä¸APIçš„é€šä¿¡å‡ºç°é—®é¢˜"
            elif not assistant_full_response and api_call_succeeded:
                final_msg = "APIå·²å“åº” (æ— æ–‡æœ¬å†…å®¹)"
            stop_loading_animation(success=api_call_succeeded, final_message=final_msg)

    if api_call_succeeded and assistant_full_response:
        log_debug(f"APIå®Œæ•´å“åº”å·²æ¥æ”¶ (é•¿åº¦: {len(assistant_full_response)}).")
        return assistant_full_response
    return None


# --- ä¸»ç¨‹åº ---
def main():
    initialize_logger(config_debug_mode=config.DEBUG_MODE, app_name=f"{config.AI_NAME}_ChatRAG")

    rag_initialized_successfully = False
    flat_historical_messages, historical_sessions_map = [], {}

    start_loading_animation(
        message=f"{TermColors.CYAN}{config.AI_NAME}æ­£åœ¨æ•´ç†å›å¿†æ€ç»ª{TermColors.RESET}",
        animation_style_key='dots')

    init_success = False
    init_final_message = "ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥" # é»˜è®¤å¤±è´¥æ¶ˆæ¯

    try:
        if initialize_rag_components():
            rag_initialized_successfully = True
            log_debug("å¼€å§‹åŠ è½½å†å²è®°å½•å¹¶æ›´æ–°RAGç´¢å¼•...")
            flat_historical_messages, historical_sessions_map = load_all_historical_data()

            if flat_historical_messages and chroma_collection is not None:
                add_messages_to_rag_index(flat_historical_messages)
                init_final_message = f"ç¨‹åºå·²å°±ç»ª"
                log_debug("ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆã€‚RAGç´¢å¼•åŒ…å« {chroma_collection.count()} æ¡è®°å½•ã€‚")
            elif chroma_collection is not None:
                init_final_message = "ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆã€‚RAGå°±ç»ª (æ— å†å²æ•°æ®ç´¢å¼•)ã€‚"
            else:
                init_final_message = "ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œä½†RAGæ•°æ®å¤„ç†å¼‚å¸¸æˆ–RAGæœªå¯ç”¨ã€‚"
            init_success = True # RAGç»„ä»¶åˆå§‹åŒ–æˆåŠŸå¹¶å¤„ç†å®Œæ•°æ®ï¼Œæ ‡è®°ä¸ºæˆåŠŸ

        else:
            log_info_color("RAGç»„ä»¶åˆå§‹åŒ–å¤±è´¥ã€‚å°è¯•ä»…åŠ è½½å†å²è®°å½•...", TermColors.YELLOW)
            flat_historical_messages, historical_sessions_map = load_all_historical_data()
            init_final_message = "RAGç»„ä»¶åˆå§‹åŒ–å¤±è´¥ã€‚RAGåŠŸèƒ½å°†ä¸å¯ç”¨ã€‚å†å²è®°å½•å·²åŠ è½½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚"
            init_success = True # åŠ è½½å†å²è®°å½•æœ¬èº«å¯ä»¥è®¤ä¸ºæ˜¯éƒ¨åˆ†çš„æˆåŠŸ

    except Exception as e:
        log_error_color(f"åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–ä¸¥é‡é”™è¯¯: {e}")
        log_debug(f"Unexpected initialization error: {e}", exc_info=True)
        init_final_message = "åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯"
        init_success = False # ä»»ä½•éé¢„æœŸçš„é”™è¯¯éƒ½æ ‡è®°ä¸ºå¤±è´¥
    finally:
        stop_loading_animation(success=init_success, final_message=init_final_message)

    if rag_initialized_successfully and chroma_collection:
        log_debug(f"RAGå·²å‡†å¤‡å°±ç»ªï¼ŒçŸ¥è¯†åº“åŒ…å« {chroma_collection.count()} æ¡å‘é‡åŒ–å†å²æ¶ˆæ¯ã€‚")

    elif config.USE_RAG:
        log_debug("RAGåˆå§‹åŒ–å¤±è´¥æˆ–å†å²ä¸ºç©ºã€‚é—®ç­”å¯èƒ½ä»…ä¾èµ–å½“å‰ä¼šè¯ã€‚")

    else:
        log_info("RAGåŠŸèƒ½å·²ç¦ç”¨ã€‚é—®ç­”å°†ä»…ä¾èµ–å½“å‰ä¼šè¯ã€‚")


    # --- ä¼šè¯ä¸»å¾ªç¯å¼€å§‹ ---
    current_session_messages = []
    session_filepath = get_history_filepath()
    print(f"{TermColors.GREY}è¾“å…¥ 'exit' æˆ– 'quit' é€€å‡ºã€‚æœ¬æ¬¡ä¼šè¯è®°å½•åˆ°: {session_filepath}{TermColors.RESET}")

    while True:
        try:
            user_input = input(f"{TermColors.YELLOW}ä½ : {TermColors.RESET}")
        except UnicodeDecodeError:
            log_error_color("ç³»ç»Ÿæ£€æµ‹åˆ°æ— æ³•è¯†åˆ«çš„è¾“å…¥å­—ç¬¦ã€‚");
            continue
        except EOFError:
            print("\nå†è§ï¼(EOF)");
            break
        except KeyboardInterrupt:
            print("\nå†è§ï¼(ä¸­æ–­)");
            break

        if user_input.lower() in ["exit", "quit", "é€€å‡º"]:
            print("å†è§ï¼");
            break
        if not user_input.strip():
            continue

        api_payload_messages = []

        # --- æ­¥éª¤ A: å‡†å¤‡å„ç§æ¶ˆæ¯ç»„ä»¶ ---

        # A1. è·å–å½“å‰æ—¶é—´å¹¶åˆ›å»ºæ—¶é—´æç¤º (æ¯æ¬¡è¯·æ±‚éƒ½è·å–)
        current_time_str = datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S")
        time_system_message = {"role": "system", "content": f"assistant_hint: å½“å‰æé—®æ—¶é—´æ˜¯ {current_time_str}ã€‚"}
        # log_debug ç§»åŠ¨åˆ°æ·»åŠ æ—¶è®°å½•

        # A2. å‡†å¤‡é…ç½®ä¸­çš„ç³»ç»Ÿæç¤º (å¦‚æœå­˜åœ¨)
        config_system_prompt_message = None
        if config.SYSTEM_PROMPT and config.SYSTEM_PROMPT.strip():
            config_system_prompt_message = {"role": "system", "content": config.SYSTEM_PROMPT}
            # log_debug ç§»åŠ¨åˆ°æ·»åŠ æ—¶è®°å½•

        # A3. å¤„ç† RAG æ£€ç´¢ï¼Œå¹¶å°†ç»“æœæ”¶é›†åˆ° rag_messages_to_add åˆ—è¡¨
        rag_messages_to_add = []
        if config.USE_RAG and rag_initialized_successfully and chroma_collection and chroma_collection.count() > 0:
            start_loading_animation(
                message=f"{TermColors.MAGENTA}{config.AI_NAME}æ­£åœ¨ç¿»çœ‹è®°äº‹æœ¬{TermColors.RESET}",
                animation_style_key='arrows', animation_color=TermColors.MAGENTA
            )
            rag_success_flag, rag_final_msg = False, "RAGæ£€ç´¢å®Œæˆ"
            rag_context_messages = []
            try:
                rag_context_messages = get_rag_messages_chroma(user_input, historical_sessions_map)
                rag_success_flag = True
                if rag_context_messages:
                    rag_final_msg = f"RAGæ£€ç´¢å®Œæ¯• (æ‰¾åˆ° {len(rag_context_messages)} æ¡ç›¸å…³å†å²)"
                else:
                    rag_final_msg = "RAGæ£€ç´¢å®Œæ¯• (æœªæ‰¾åˆ°ç›¸å…³å†å²)"
            except Exception as e_rag:
                log_error_color(f"RAGæ£€ç´¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e_rag}")
                log_debug(f"RAG retrieval error: {e_rag}", exc_info=True)
                rag_final_msg = "RAGæ£€ç´¢å¤±è´¥"
                rag_success_flag = False # RAG æ£€ç´¢å¤±è´¥
            finally:
                stop_loading_animation(success=rag_success_flag, final_message=rag_final_msg)

            if rag_context_messages:
                rag_prefix_content = config.RAG_PROMPT_PREFIX
                if not rag_prefix_content or not rag_prefix_content.strip():
                    rag_prefix_content = "ä»¥ä¸‹æ˜¯æ ¹æ®ä½ çš„é—®é¢˜ä»å†å²å¯¹è¯ä¸­æ£€ç´¢åˆ°çš„ç›¸å…³ç‰‡æ®µï¼Œå…¶ä¸­åŒ…å«äº†å¯¹è¯å‘ç”Ÿçš„å¤§è‡´æ—¶é—´ï¼š"
                rag_messages_to_add.append({"role": "system", "content": rag_prefix_content})
                rag_messages_to_add.extend(rag_context_messages)
                if config.RAG_PROMPT_SUFFIX and config.RAG_PROMPT_SUFFIX.strip():
                    rag_messages_to_add.append({"role": "system", "content": config.RAG_PROMPT_SUFFIX})
                # log_debug ç§»åŠ¨åˆ°æ·»åŠ æ—¶è®°å½•
        else:
            reasons = [r for r, c in [("USE_RAGä¸ºFalse", not config.USE_RAG),
                                      ("RAGæœªæˆåŠŸåˆå§‹åŒ–", not rag_initialized_successfully),
                                      ("Chromaé›†åˆä¸å¯ç”¨", chroma_collection is None),
                                      ("Chromaé›†åˆä¸ºç©º",
                                       chroma_collection is not None and chroma_collection.count() == 0)] if c]
            if reasons: log_debug(f"è·³è¿‡RAGæ£€ç´¢ï¼ŒåŸå› : {', '.join(reasons)}ã€‚")

        # --- æ­¥éª¤ B: æŒ‰æ–°é¡ºåºç»„è£… api_payload_messages ---

        # B1. æ·»åŠ  RAG æ¶ˆæ¯ (å¦‚æœå­˜åœ¨)
        if rag_messages_to_add:
            api_payload_messages.extend(rag_messages_to_add)
            log_debug(f"å·²æ·»åŠ  {len(rag_messages_to_add)} æ¡RAGæ¶ˆæ¯(åŒ…æ‹¬å‰åç¼€)ã€‚")

        # B2. æ·»åŠ é…ç½®ä¸­çš„ç³»ç»Ÿæç¤º (åœ¨RAGä¹‹å)
        if config_system_prompt_message:
            api_payload_messages.append(config_system_prompt_message)
            log_debug(f"å·²æ·»åŠ ç³»ç»Ÿæç¤º: \"{config_system_prompt_message['content'][:100].strip().replace(chr(10), ' ')}...\"")

        # B3. æ·»åŠ å½“å‰æ—¶é—´æç¤º (åœ¨é…ç½®ç³»ç»Ÿæç¤ºä¹‹å)
        api_payload_messages.append(time_system_message)
        log_debug(f"å·²æ·»åŠ å½“å‰æ—¶é—´æç¤º: \"{time_system_message['content']}\"")

        # B4. æ·»åŠ å½“å‰ä¼šè¯çš„æ»‘åŠ¨çª—å£å†å²
        temp_sliding_window = current_session_messages[-(
            config.MAX_CONTEXT_MESSAGES_SLIDING_WINDOW - 1 if config.MAX_CONTEXT_MESSAGES_SLIDING_WINDOW > 0 else 0):]
        if temp_sliding_window: # ä»…å½“æœ‰å†å²æ—¶æ‰æ·»åŠ å’Œè®°å½•
            api_payload_messages.extend(temp_sliding_window)
            log_debug(f"å·²ä»å½“å‰ä¼šè¯æ·»åŠ  {len(temp_sliding_window)} æ¡å†å²æ¶ˆæ¯ã€‚")
        else:
            log_debug("å½“å‰ä¼šè¯æ— å†å²æ¶ˆæ¯å¯æ·»åŠ ã€‚")


        # B5. æ·»åŠ å½“å‰ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
        user_message_for_payload = {"role": "user", "content": user_input}
        api_payload_messages.append(user_message_for_payload)
        log_debug(f"å·²æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯ã€‚æœ€ç»ˆPayloadæ¶ˆæ¯æ€»æ•°: {len(api_payload_messages)}")

        current_session_messages.append(user_message_for_payload)

        assistant_response = chat_with_deepseek(api_payload_messages)

        if assistant_response and assistant_response.strip():
            current_session_messages.append({"role": "assistant", "content": assistant_response})
            save_session_history(current_session_messages, session_filepath)
        else:
            log_warning_color("APIè°ƒç”¨æœªè¿”å›æœ‰æ•ˆå“åº”æˆ–å“åº”ä¸ºç©ºã€‚", TermColors.YELLOW)
            if current_session_messages and current_session_messages[-1]["role"] == "user":
                log_debug("ç”±äºAPIè°ƒç”¨å¤±è´¥/å“åº”æ— æ•ˆï¼Œä»å½“å‰ä¼šè¯è®°å½•ä¸­ç§»é™¤æœ€åç”¨æˆ·æ¶ˆæ¯ã€‚")
                current_session_messages.pop()

if __name__ == "__main__":
    if not hasattr(config, 'API_KEY') or not config.API_KEY or \
            config.API_KEY.lower() in ["your_deepseek_api_key", "sk-114514", "sk-1234"] or \
            "actual_deepseek_api_key" in config.API_KEY.lower():
        log_error("é”™è¯¯ï¼šè¯·åœ¨ config.py æ–‡ä»¶ä¸­æ­£ç¡®è®¾ç½®æ‚¨çš„ DeepSeek API_KEYã€‚")

    default_history_path = "./chat_history_data"
    if not hasattr(config, 'HISTORY_BASE_PATH') or not config.HISTORY_BASE_PATH:
        sys.stderr.write(
            f"{TermColors.YELLOW}è­¦å‘Š: config.py ä¸­æœªå®šä¹‰æˆ– HISTORY_BASE_PATH ä¸ºç©ºã€‚å°†ä½¿ç”¨é»˜è®¤è·¯å¾„: {default_history_path}{TermColors.RESET}\n")
        sys.stderr.flush()
        setattr(config, 'HISTORY_BASE_PATH', default_history_path)
    try:
        os.makedirs(config.HISTORY_BASE_PATH, exist_ok=True)
    except OSError as e:
        sys.stderr.write(
            f"{TermColors.RED}é”™è¯¯: æ— æ³•åˆ›å»ºå†å²è®°å½•ç›®å½• {config.HISTORY_BASE_PATH}: {e}{TermColors.RESET}\n")
        sys.stderr.flush()

    main()
```
ä»¥åŠå¯¼å…¥mainä¸­çš„deepseek llmè¯·æ±‚çš„å‡½æ•°ï¼Œä¸éœ€è¦å¯ç”¨RAGç³»ç»Ÿï¼Œåªæ˜¯ä¸ç”¨å†å†™ä¸€éllmè¯·æ±‚äº†ã€‚

è¯·å†™ä¸€ä¸ªä½¿ç”¨å‘½ä»¤è¡Œç»ˆç«¯æ“ä½œçš„èŠå¤©demoï¼ŒéªŒè¯è¿™ä¸ªæ¡†æ¶çš„å¯è¡Œæ€§ã€‚è¦æ±‚ï¼š

- å®Œå…¨å¤åˆ»è¿™ä¸ªæ¡†æ¶çš„æ¼”è¿›é€»è¾‘
- å½“ç”¨æˆ·è¿›å…¥ç¨‹åºæ—¶ï¼š
  - ä½¿ç”¨/startå¼€å§‹é¡¹ç›®ï¼Œæ­¤æ—¶ä¼šåˆ—å‡ºå¯é€‰çš„å‰§æœ¬å’Œäººè®¾ã€‚å¯ä»¥ç”¨è¾“å…¥çš„æ–¹å¼é€‰æ‹©å·²ç»æœ‰çš„å‰§æœ¬æ–‡ä»¶å¤¹ï¼Œç„¶åé€‰æ‹©å‰§æœ¬æ–‡ä»¶å¤¹ä¹‹åæ ¹æ®å‰§æœ¬çš„è§’è‰²æ•°é‡éœ€æ±‚ï¼Œé€‰æ‹©æ¯ä¸ªè§’è‰²çš„äººè®¾ã€‚é€‰æ‹©å®Œä¹‹åå°±æ˜¯ä»å¤´å¼€å§‹é¡¹ç›®ã€‚
- åœ¨ä»»ä½•ç©å®¶å¯è¾“å…¥çš„æ—¶å€™ï¼Œä½¿ç”¨/save --å­˜æ¡£åå­— å³å¯ä¿å­˜å­˜æ¡£ï¼Œå¦‚æœä¸å†™å­˜æ¡£ååˆ™é»˜è®¤åˆ†é…ç³»ç»Ÿæ—¶é—´ä½œä¸ºå­˜æ¡£
- åœ¨ä»»ä½•ç©å®¶å¯è¾“å…¥çš„æ—¶å€™ï¼Œä½¿ç”¨/load --å­˜æ¡£åå­— å³å¯åŠ è½½å­˜æ¡£ã€‚

è€Œä¸”è¯·ä½ ä»å¤´ç¼–å†™å‡ ä¸ªäººè®¾promptå’Œæ•´ä¸ªå‰§æœ¬yaml promptã€‚å®ç°ä¸€ä¸ªç®€å•çš„ç‹¼äººæ€ï¼š

4ä¸ªç©å®¶ï¼Œä¸‰ä¸ªæ˜¯AIï¼Œä¸€ä¸ªæ˜¯ç”¨æˆ·ï¼Œä¸€ä¸ªç‹¼äººï¼Œä¸€ä¸ªDMã€‚

è¯·å†™å‡ºæ‰€æœ‰è¦ç”¨åˆ°çš„pyä»£ç å’Œyamlæ–‡ä»¶ã€‚åŠ æ²¹ï¼